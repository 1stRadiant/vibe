<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coding System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- GrapesJS (Visual Builder) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.2/css/grapes.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.2/grapes.min.js"></script>
    
    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="style.css">
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        .shorthand-toolbar {
            background: #2a2a2a;
            padding: 8px;
            border-radius: 4px 4px 0 0;
            border: 1px solid #444;
            border-bottom: none;
        }
        
        /* Iframe container styling for Merge Tab */
        #merge iframe {
            width: 100%;
            height: 100%;
            min-height: 85vh;
            border: none;
            background: #1e1e1e;
        }

        /* --- CODE EXPLORER & PREVIEW LAYOUT STYLES --- */
        
        /* FIX: Only apply flex layout when the tab is ACTIVE */
        .tab-content#preview {
            display: none; /* Default hidden */
            padding: 0 !important; 
            height: 100%;
            overflow: hidden;
            flex-direction: column;
        }
        
        .tab-content#preview.active {
            display: flex !important; /* Only flex when active */
        }

        .preview-layout-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        #preview-top-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Iframe handles internal scrolling */
            min-height: 0; /* Important for flex container scrolling */
            position: relative;
        }

        #preview-resizer {
            height: 12px;
            background: #212529;
            cursor: row-resize;
            flex-shrink: 0;
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            display: none; /* Hidden by default */
            z-index: 100;
            position: relative;
            align-items: center;
            justify-content: center;
        }
        
        #preview-resizer:hover {
            background: #0d6efd;
        }

        #preview-resizer::after {
            content: "••••";
            color: #6c757d;
            font-size: 12px;
            letter-spacing: 2px;
            position: absolute;
            top: -5px; 
        }

        #explorer-panel {
            height: 0; /* Starts hidden */
            background: #1e1e1e; /* VS Code dark bg */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #333;
            transition: height 0.1s ease-out;
        }
        
        #explorer-panel.active {
            height: 350px; /* Default height when opened */
        }

        /* Module Styles */
        .ce-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #ccc;
            padding: 15px;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            font-size: 13px;
            overflow: hidden; /* Prevent double scrollbars on container */
        }

        .ce-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .ce-header h4 { margin: 0; font-size: 15px; color: #fff; font-weight: 600; }

        .ce-search-section {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            margin-bottom: 15px;
        }

        .ce-search-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            background: #252526;
            color: #fff;
            font-family: inherit;
        }

        .ce-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            background: #0d6efd;
            color: #fff;
            cursor: pointer;
            font-weight: 500;
        }
        .ce-btn:hover { background: #0b5ed7; }

        .ce-results {
            max-height: 100px;
            overflow-y: auto;
            flex-shrink: 0;
            border-bottom: 1px solid #333;
            margin-bottom: 15px;
        }

        .ce-output {
            flex: 1;
            overflow-y: auto; /* Main scrolling area for content */
            padding-right: 5px;
            min-height: 0;
        }

        /* Code Blocks */
        .ce-code-block {
            background: #1e1e1e;
            padding: 0;
            margin-bottom: 20px;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        
        .ce-code-block h3, .ce-code-block h4 {
            font-size: 13px;
            color: #9cdcfe;
            margin-bottom: 8px;
            font-weight: normal;
        }

        .ce-code-content {
            color: #d4d4d4;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
            /* Removed max-height to allow full scrolling within the panel */
            max-height: none; 
            overflow-y: visible;
            background: #1e1e1e;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
        }
        
        /* Syntax Colors */
        .ce-function-name { color: #dcdcaa; font-weight: bold; font-size: 1.1em; display: block; margin-bottom: 5px; }
        .ce-css-rules { color: #ce9178; }
        .ce-function-link { 
            color: #4fc1ff; 
            text-decoration: none; 
            cursor: pointer; 
            margin-right: 8px; 
            border-bottom: 1px dotted #444;
        }
        .ce-function-link:hover { 
            text-decoration: underline; 
            color: #9cdcfe;
        }
        .ce-search-result { padding: 6px; margin: 2px 0; cursor: pointer; border-radius: 3px; }
        .ce-search-result:hover { background: #2a2d2e; }
        .ce-result-type { color: #569cd6; font-weight: bold; margin-right: 8px; font-size: 0.9em; }

        .ce-navigation { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        
        .ce-btn-small {
            padding: 4px 12px;
            font-size: 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ce-btn-small:hover { background: #4c4c4c; border-color: #777; }

        /* GrapesJS Custom Styles to fit Dark Theme */
        .gjs-cv-canvas {
            background-color: #212529;
            width: 100%;
            height: 100%;
            top: 0;
        }
        .gjs-one-bg {
            background-color: #1e1e1e;
        }
        .gjs-two-color {
            color: #ddd;
        }
        .gjs-three-bg {
            background-color: #2a2a2a;
            color: #ddd;
        }
        .gjs-four-color, .gjs-four-color-h:hover {
            color: #0d6efd;
        }
        
        #nocode-toolbar {
            padding: 10px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #nocode-save-btn {
            background-color: #0d6efd;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        #nocode-save-btn:hover { background-color: #0b5ed7; }
    </style>

<style><!-- GrapesJS (Visual Builder) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.2/css/grapes.min.css">


<!-- NEW: GrapesJS Preset Webpage (The "Wix-like" UI and Blocks) -->
<link rel="stylesheet" href="https://unpkg.com/grapesjs-preset-webpage@0.1.15/dist/grapesjs-preset-webpage.min.css"></style>
</head>
<body>

    <!-- Login Modal -->
    <div id="auth-modal" class="modal" style="display: block;">
        <div class="modal-content">
            <h2 id="auth-title">Login</h2>
            <div id="auth-error" class="modal-error"></div>
            <div id="login-form">
                <label for="login-username">Username</label>
                <input type="text" id="login-username" autocomplete="username">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" autocomplete="current-password">
                <button id="login-button" class="action-button">Login</button>
                <p>Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
            </div>
            <div id="signup-form" style="display: none;">
                <label for="signup-username">Username</label>
                <input type="text" id="signup-username" autocomplete="username">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" autocomplete="new-password">
                <button id="signup-button" class="action-button">Sign Up</button>
                <p>Already have an account? <a href="#" id="show-login">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app-container" style="width:100%; height: 100vh; display: none;">
        <div class="container-fluid">
            <div class="row flex-nowrap">
                <!-- Desktop Sidebar -->
                <div class="col-auto px-0 bg-dark d-none d-md-flex">
                    <div class="d-flex flex-column align-items-center pt-2 text-white min-vh-100">
                        <a href="#" class="d-flex align-items-center p-3 text-info text-decoration-none" title="Vibe Coding System">
                           <span class="fs-4" style="font-weight: bold;"></span>
                        </a>
                        <ul class="nav nav-pills flex-column mb-auto text-center" id="menu">
                            <li class="nav-item">
                                <a href="#" class="nav-link py-3 px-2 tab-button active" data-tab="start" title="Start">
                                    <i class="fs-4 bi-house"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="preview" title="Live Preview">
                                    <i class="fs-4 bi-display"></i>
                                </a>
                            </li>
                            <!-- NEW NO-CODE TAB BUTTON -->
                            <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="nocode" title="Visual Builder">
                                    <i class="fs-4 bi-palette"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="editor" title="Vibe Editor">
                                    <i class="fs-4 bi-pencil-square"></i>
                                </a>
                            </li>
                             <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="agent" title="Agent">
                                    <i class="fs-4 bi-robot"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="chat" title="Chat">
                                    <i class="fs-4 bi-chat-dots"></i>
                                </a>
                            </li>
                             <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="flowchart" title="Flowchart">
                                    <i class="fs-4 bi-diagram-3"></i>
                                </a>
                            </li>
                             <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="console" title="Console">
                                    <i class="fs-4 bi-terminal"></i><span id="console-error-indicator"></span>
                                </a>
                            </li>
                             <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="files" title="Files">
                                    <i class="fs-4 bi-folder"></i>
                                </a>
                            </li>
                             <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="context" title="Context">
                                    <i class="fs-4 bi-archive"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="code" title="Full Code">
                                    <i class="fs-4 bi-code-slash"></i>
                                </a>
                            </li>
                            <!-- NEW MERGE TAB BUTTON -->
                            <li>
                                <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="merge" title="Smart Merge">
                                    <i class="fs-4 bi-git"></i>
                                </a>
                            </li>
                        </ul>
                        <div class="dropdown pb-4">
                            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle p-3" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fs-4 bi-person-circle"></i>
                                <span class="d-none" id="user-status-text">User</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                                <li><a class="dropdown-item" href="#" id="new-project-button">New project...</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#" id="logout-button">Sign out</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="col py-3" style="height: 100vh; overflow: hidden; position: relative;">
                    <div class="main-toolbar d-flex justify-content-end align-items-start" style="position: absolute; right: 20px; top: 10px; z-index: 1000;">
                        <div class="btn-group me-2" role="group" aria-label="Save actions">
                            <button class="btn btn-primary" type="button" id="save-to-cloud-button" disabled title="Save to Cloud (Ctrl/Cmd + S)">
                                <i class="bi bi-cloud-arrow-up"></i>
                            </button>
                            <button class="btn btn-secondary" type="button" id="save-to-local-button" disabled title="Save to Local Storage">
                                <i class="bi bi-hdd"></i>
                            </button>
                            <button class="btn btn-dark" type="button" id="save-to-github-button" disabled title="Save to GitHub">
                                <i class="bi bi-github"></i>
                            </button>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="More options">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <button class="dropdown-item" type="button" id="open-ai-structure-modal-button" disabled>
                                        <i class="bi bi-diagram-2 me-2"></i>AI Structure
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button class="dropdown-item" type="button" id="share-project-button" disabled>
                                        <i class="bi bi-share me-2"></i>Share Project
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button class="dropdown-item" type="button" id="undo-button">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Undo
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" type="button" id="redo-button">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Redo
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="tab-content-area" style="height: 100%;">
                        <div id="start" class="tab-content active">
                             <div class="start-page-content">
                                <!-- ... Start Page Content (No changes) ... -->
                                <div class="start-header d-flex justify-content-between align-items-center">
                                    <h1>Vibe</h1>
                                    <button id="start-page-settings-button" class="settings-button" title="API Settings">⚙️</button>
                                </div>
                                
                                <div class="accordion" id="start-page-accordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingProjects">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProjects" aria-expanded="true" aria-controls="collapseProjects">
                                                Your Projects
                                            </button>
                                        </h2>
                                        <div id="collapseProjects" class="accordion-collapse collapse show" aria-labelledby="headingProjects" data-bs-parent="#start-page-accordion">
                                            <div class="accordion-body">
                                                <div class="storage-toggle btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-primary active" data-storage="cloud">
                                                        <i class="bi bi-cloud me-1"></i> Cloud
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary" data-storage="local">
                                                        <i class="bi bi-hdd me-1"></i> Local
                                                    </button>
                                                </div>
                                                <div id="project-list"></div>
                                                <p id="no-projects-message" style="display: none;">You have no saved projects. Create one below!</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item" id="github-load-container" style="display: none;">
                                        <h2 class="accordion-header" id="headingGithub">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGithub" aria-expanded="false" aria-controls="collapseGithub">
                                                Load from GitHub
                                            </button>
                                        </h2>
                                        <div id="collapseGithub" class="accordion-collapse collapse" aria-labelledby="headingGithub" data-bs-parent="#start-page-accordion">
                                            <div class="accordion-body">
                                                <div class="form-group">
                                                    <label for="github-repo-select">Repository</label>
                                                    <select id="github-repo-select" class="form-select">
                                                        <option>-- Connect to GitHub in Settings --</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="github-branch-select">Branch</label>
                                                    <select id="github-branch-select" class="form-select">
                                                        <option>-- Select a Repo First --</option>
                                                    </select>
                                                </div>
                                                <button id="load-from-github-button" class="action-button primary"><i class="bi bi-github me-2"></i>Load Project</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingNewProject">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNewProject" aria-expanded="false" aria-controls="collapseNewProject">
                                                Create a New Project
                                            </button>
                                        </h2>
                                        <div id="collapseNewProject" class="accordion-collapse collapse" aria-labelledby="headingNewProject" data-bs-parent="#start-page-accordion">
                                            <div class="accordion-body">
                                                <div class="new-project-form">
                                                    <div class="form-group">
                                                        <label for="new-project-id-input">Project Name</label>
                                                        <input type="text" id="new-project-id-input" placeholder="my-awesome-new-site">
                                                    </div>
                                                     <div class="form-group">
                                                        <label>Save Location</label>
                                                         <div class="btn-group" role="group" aria-label="New project storage location">
                                                             <input type="radio" class="btn-check" name="projectStorage" id="storageCloud" value="cloud" autocomplete="off" checked>
                                                             <label class="btn btn-outline-primary" for="storageCloud"><i class="bi bi-cloud me-1"></i> Cloud</label>

                                                             <input type="radio" class="btn-check" name="projectStorage" id="storageLocal" value="local" autocomplete="off">
                                                             <label class="btn btn-outline-primary" for="storageLocal"><i class="bi bi-hdd me-1"></i> Local</label>
                                                         </div>
                                                     </div>
                                                </div>
                                                
                                                <hr class="section-divider">

                                                <div class="project-creation-method">
                                                    <h3>From a High-Level Goal</h3>
                                                    <p>Describe your website, and let the AI figure out the structure and code.</p>

                                                    <!-- START SHORTHAND TOOLBAR -->
                                                    <div class="shorthand-toolbar d-flex gap-2">
                                                        <select id="start-component-shorthand-select" class="form-select form-select-sm" style="flex: 1; background: #1e1e1e; color: #ccc; border-color: #444;">
                                                            <option value="">-- Insert Component Library (@) --</option>
                                                        </select>
                                                        <button id="start-insert-shorthand-button" class="btn btn-sm btn-outline-info">Insert</button>
                                                    </div>
                                                    <!-- END SHORTHAND TOOLBAR -->

                                                    <textarea id="project-prompt-input" placeholder="e.g., 'A modern portfolio website for a photographer...'"></textarea>
                                                    
                                                    <!-- VIBE SHORTHAND GUIDE START -->
                                                    <details class="syntax-guide" style="margin-top: 10px; margin-bottom: 10px; border: 1px solid #444; border-radius: 5px; background: #2a2a2a;">
                                                        <summary style="padding: 10px; cursor: pointer; font-weight: bold; color: #61afef;">Advanced: Use Vibe Shorthand</summary>
                                                        <div style="padding: 10px; font-size: 0.9em; color: #ccc;">
                                                            <p>Type <code>#</code> to reference existing nodes or <code>@</code> to use components from your library.</p>
                                                            <p><strong>Syntax Example:</strong></p>
                                                            <pre style="background: #1e1e1e; padding: 10px; border-radius: 4px; color: #98c379; overflow-x: auto;">
1. Hero Section
   Type: @hero-banner
   Overrides:
     - Title: "Welcome Home"
     - Button: "Get Started"</pre>
                                                        </div>
                                                    </details>
                                                    <!-- VIBE SHORTHAND GUIDE END -->

                                                    <div class="button-container">
                                                        <button hidden id="generate-project-button" class="action-button primary"><i class="bi bi-stars me-2"></i>Generate Project</button>                                                        
                                                        <button id="start-iterative-build-button" class="action-button agent"><i class="bi bi-robot me-2"></i>Build</button>
                                                    </div>
                                                </div>
                                                
                                                <div class="project-creation-method">
                                                    <h3>From Structural Instructions</h3>
                                                    <p>Tell the AI exactly how to structure the Vibe Nodes for boilerplate generation.</p>
                                                    <textarea id="project-instructions-input" placeholder="e.g., 'Create a header, a main section with three feature cards, and a footer. Also add a global CSS node for styles.'"></textarea>
                                                    <div class="button-container">
                                                        <button id="generate-from-instructions-button" class="action-button primary"><i class="bi bi-diagram-2 me-2"></i>Generate from Instructions</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="start-page-generation-output" style="display: none;">
                                    <div id="generation-status-container">
                                        <h3 id="generation-status-text">Generating your project...</h3>
                                        <div class="loading-spinner"></div>
                                    </div>
                                    <div id="live-code-container">
                                        <pre><code id="live-code-output" class="language-html"></code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MODIFIED PREVIEW TAB WITH CODE EXPLORER SPLIT PANE -->
                        <div id="preview" class="tab-content">
                            <div class="preview-layout-wrapper">
                                <!-- Top Pane: Preview Header + Iframe -->
                                <div id="preview-top-pane">
                                    <!-- Header: Buttons on LEFT to avoid overlap with global toolbar -->
                                    <div class="preview-header d-flex align-items-center" style="padding: 12px 16px; background: #212529; color: white; border-bottom: 1px solid #444; height: 60px;">
                                        <h2 style="margin: 0; font-size: 1.1rem; font-weight: 500; margin-right: 15px;">Live Preview</h2>
                                        <button id="code-explorer-toggle-btn" class="btn btn-outline-info" style="padding: 4px 12px; font-size: 0.9rem;">
                                            <i class="bi bi-bug me-2"></i>Enable Inspect
                                        </button>
                                    </div>
                                    <iframe id="website-preview" title="Live Website Preview" style="width:100%; height: 100%; border:none; flex: 1; background: #fff;"></iframe>
                                </div>
                                
                                <!-- Resizer Handle -->
                                <div id="preview-resizer"></div>
                                
                                <!-- Bottom Pane: Code Explorer -->
                                <div id="explorer-panel">
                                    <!-- Content injected by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- NEW NO-CODE VISUAL BUILDER TAB -->
                        <div id="nocode" class="tab-content" style="height: 100vh; padding: 0; overflow: hidden; display: none;">
                            <div id="nocode-toolbar">
                                <span style="font-weight: bold; color: white;">Visual Builder</span>
                                <button id="nocode-save-btn">
                                    <i class="bi bi-floppy me-2"></i>Save Visual Changes
                                </button>
                            </div>
                            <div id="gjs" style="height: calc(100% - 50px); overflow: hidden; border: none;"></div>
                        </div>

                        <div id="editor" class="tab-content">
                            <!-- ... Editor Content ... -->
                             <div class="editor-container">
                                <div class="editor-header">
                                    <div class="editor-header-left">
                                        <h2>Vibe</h2>
                                        <p>Edit the descriptions to change the website. Updating a parent will automatically update its children.</p>
                                    </div>
                                    <div class="editor-header-right">
                                        <div id="ai-editor-search-container">
                                            <input type="text" id="ai-editor-search-input" placeholder="AI Search: 'find the navbar styles'">
                                            <button id="ai-editor-search-button" class="action-button">Search</button>
                                        </div>
                                        <button id="open-settings-modal-button" class="action-button">API Settings</button>
                                    </div>
                                </div>
                                <div id="vibe-editor"></div>
                            </div>
                        </div>
                        <div id="agent" class="tab-content">
                            <!-- ... Agent Content ... -->
                             <div class="agent-container">
                                <h2>Vibe</h2>
                                <p>Add one or more tasks for the AI to complete. It will process them sequentially when you click "Process Queue".</p>
                                
                                <div id="agent-controls">
                                    <!-- START SHORTHAND TOOLBAR -->
                                    <div class="shorthand-toolbar d-flex gap-2">
                                        <select id="agent-component-shorthand-select" class="form-select form-select-sm" style="flex: 1; background: #1e1e1e; color: #ccc; border-color: #444;">
                                            <option value="">-- Insert Component Library (@) --</option>
                                        </select>
                                        <button id="agent-insert-shorthand-button" class="btn btn-sm btn-outline-info">Insert</button>
                                    </div>
                                    <!-- END SHORTHAND TOOLBAR -->

                                    <textarea id="agent-prompt-input" rows="3" placeholder="Describe a task to add to the queue..."></textarea>
                                    <!-- AGENT SYNTAX HINT START -->
                                    <div class="input-hint" style="font-size: 0.85em; color: #888; margin-bottom: 10px; display: flex; justify-content: space-between;">
                                        <span>Type <strong>@</strong> to reference components, <strong>#</strong> to reference nodes.</span>
                                        <details style="display: inline-block;">
                                            <summary style="cursor: pointer; color: #61afef;">Show Syntax</summary>
                                            <div style="position: absolute; background: #222; border: 1px solid #444; padding: 10px; z-index: 100; width: 300px; border-radius: 4px; margin-top: 5px;">
                                                <strong>Vibe Shorthand:</strong><br>
                                                <pre style="margin: 5px 0; color: #98c379;">
[New Section]
  Type: @card-grid
  Overrides:
    - Title: "Services"</pre>
                                            </div>
                                        </details>
                                    </div>
                                    <!-- AGENT SYNTAX HINT END -->
                                    <div class="agent-buttons-container">
                                        <button id="run-agent-single-task-button" class="action-button">Add Task</button>
                                        <button id="start-iterative-session-button" class="action-button">Process Queue</button>
                                        <button id="end-session-button" style="display: none;">Stop Queue</button>
                                    </div>
                                </div>

                                <div id="agent-output-container">
                                    <h3>Agent Log</h3>
                                    <div id="agent-output">
                                        <div class="agent-message-placeholder">The agent's plan and actions will appear here.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="chat" class="tab-content">
                            <!-- ... Chat Content ... -->
                             <div class="chat-container">
                                <h2>Vibe</h2>
                                <div class="system-prompt-container">
                                    <label for="chat-system-prompt-input">System Prompt (Optional)</label>
                                    <textarea id="chat-system-prompt-input" placeholder="e.g., You are a helpful assistant that only replies in haikus."></textarea>
                                </div>
                                <div class="chat-output-container">
                                    <div id="chat-output">
                                        <div class="chat-message-placeholder">Start the conversation by typing a message below.</div>
                                    </div>
                                </div>
                                <div class="chat-controls">
                                    <textarea id="chat-prompt-input" placeholder="Ask the AI anything about your project..."></textarea>
                                    <button id="send-chat-button" class="action-button">Send</button>
                                </div>
                            </div>
                        </div>
                        <div id="flowchart" class="tab-content">
                            <!-- ... Flowchart Content ... -->
                             <div class="flowchart-container">
                                <h2>Vibe</h2>
                                <p>This flowchart visualizes the user interactions and logic defined in your website's code.</p>
                                <div class="flowchart-controls">
                                    <button id="generate-flowchart-button" class="action-button">Generate Flowchart</button>
                                </div>
                                <div id="flowchart-output">
                                    <div class="flowchart-placeholder">Click "Generate Flowchart" to create a diagram of your website's logic.</div>
                                </div>
                            </div>
                        </div>
                        <div id="console" class="tab-content">
                             <div id="console-container">
                                <h2>Vibe</h2>
                                <div id="console-output"></div>
                            </div>
                        </div>
                        <div id="files" class="tab-content">
                            <!-- ... Files Content ... -->
                             <div class="files-container">
                                <h2>Vibe</h2>
                                <p>Manage files for this project. You can upload images, fonts, JSON, and other assets. Reference them in code using their paths (e.g., "assets/images/logo.png").</p>
                                <div class="files-toolbar">
                                    <input type="file" id="files-upload-input" multiple style="display: none;">
                                    <button id="files-upload-button" class="action-button">Upload</button>
                                    <button id="files-new-folder-button" class="action-button">New Folder</button>
                                    <button id="files-new-file-button" class="action-button">New File</button>
                                    <button id="files-download-button" class="action-button">Download</button>
                                    <button id="files-copy-button" class="action-button">Copy</button>
                                    <button id="files-paste-button" class="action-button">Paste</button>
                                    <button id="files-rename-button" class="action-button">Rename</button>
                                    <button id="files-delete-button" class="action-button danger">Delete</button>
                                </div>
                                <div class="assets-hint">
                                    <strong>Hint:</strong> You can reference these assets in your prompts and code. The AI receives a list of available assets. Use paths exactly as shown below.
                                </div>
                                <div class="files-browser">
                                    <div class="files-tree" id="files-tree"></div>
                                    <div class="files-preview" id="files-preview">
                                        <div class="files-preview-placeholder">Select a file to preview it here.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div id="context" class="tab-content">
                            <!-- ... Context Content ... -->
                             <div class="context-container">
                                <h2>Vibe</h2>
                                <p>Create and manage reusable components (HTML, CSS, JS). The AI will use this library as context to improve generation quality and consistency.</p>
                                <div class="context-browser">
                                    <div class="context-list-panel">
                                        <h3>Components</h3>
                                        <div id="context-component-list"></div>
                                        <button id="add-new-component-button" class="action-button">Add New Component</button>
                                        <div class="context-io-buttons" style="margin-top: 15px; display: flex; gap: 10px;">
                                            <input type="file" id="context-upload-input" accept=".json,application/json" style="display: none;">
                                            <button id="upload-context-button" class="action-button" title="Import a component library from a .json file">Upload Library</button>
                                            <button id="download-context-button" class="action-button" title="Export the current component library to a .json file">Download Library</button>
                                        </div>
                                    </div>
                                    <div id="context-component-viewer" class="context-viewer-panel">
                                        <div class="files-preview-placeholder">Select a component to view it here.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="code" class="tab-content">
                            <!-- ... Full Code Content ... -->
                             <div class="full-code-container">
                                <h2>Vibe</h2>
                                <div class="file-io-section">
                                    <div class="file-upload-container">
                                        <p>Load a single HTML file into the editor.</p>
                                        <input type="file" id="html-file-input" accept=".html,text/html" style="display: none;">
                                        <button id="upload-html-button" class="action-button"><i class="bi bi-file-earmark-code"></i> Upload HTML</button>
                                    </div>
                                    <div class="file-upload-container">
                                        <p>Load a full website from a ZIP file.</p>
                                        <input type="file" id="zip-file-input" accept=".zip,application/zip" style="display: none;">
                                        <button id="upload-zip-button" class="action-button"><i class="bi bi-file-earmark-zip"></i> Upload ZIP</button>
                                    </div>
                                    <div class="file-upload-container">
                                        <p>Download your current project as a ZIP.</p>
                                        <button id="download-zip-button" class="action-button"><i class="bi bi-download"></i> Download ZIP</button>
                                    </div>
                                </div>
                                <hr/>
                                <div class="search-container">
                                    <input type="text" id="search-input" placeholder="Find in code...">
                                    <button id="find-prev-button" class="action-button">&lt; Prev</button>
                                    <button id="find-next-button" class="action-button">Next &gt;</button>
                                    <span id="search-results-count"></span>
                                </div>
                                <textarea id="full-code-editor" class="form-control" rows="25" style="width: 100%; height: 600px !important; min-height: 60vh; font-family: 'Roboto Mono', monospace; font-size: 14px; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #444; border-radius: 5px; padding: 10px;"></textarea>
                                <div class="full-code-actions">
                                    <button id="update-tree-from-code-button" class="action-button">
                                        <i class="bi bi-arrow-clockwise"></i> Update from Code
                                    </button>
                                    <div class="ai-prompt-container">
                                        <input type="text" id="full-code-ai-prompt" placeholder="Select code and describe your change..."/>
                                        <button id="run-full-code-ai-button" class="action-button primary ai-powered-button">
                                            <i class="bi bi-stars"></i> Update with AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- NEW MERGE TAB CONTENT (REPLACED WITH IFRAME) -->
                        <div id="merge" class="tab-content">
                            <iframe src="https://1stradiant.github.io/vibe/segment.html" title="Smart Merge Tool"></iframe>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation for Mobile -->
    <div class="fixed-bottom bg-dark d-md-none">
        <div class="d-flex justify-content-around">
            <a href="#" class="nav-link py-3 px-2 tab-button active" data-tab="start" title="Start">
                <i class="fs-4 bi-house text-white"></i>
            </a>
            <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="preview" title="Live Preview">
                <i class="fs-4 bi-display text-white"></i>
            </a>
             <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="nocode" title="Visual Builder">
                <i class="fs-4 bi-palette text-white"></i>
            </a>
            <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="editor" title="Vibe Editor">
                <i class="fs-4 bi-pencil-square text-white"></i>
            </a>
            <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="agent" title="Agent">
                <i class="fs-4 bi-robot text-white"></i>
            </a>
            <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="files" title="Files">
                <i class="fs-4 bi-folder text-white"></i>
            </a>
            <a href="#" class="nav-link py-3 px-2 tab-button" data-tab="code" title="Full Code">
                <i class="fs-4 bi-code-slash text-white"></i>
            </a>
        </div>
    </div>
    
    <!-- Modals (unchanged) -->
    <!-- ... (Add Node Modal, Settings Modal, etc. from original file) ... -->
     <div id="add-node-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Add New Child Node</h2>
            <p>Define the new component to add to the selected container.</p>
            <input type="hidden" id="add-node-parent-id">
            <input type="hidden" id="add-node-target-id">
            <input type="hidden" id="add-node-position">
            <label for="new-node-id">New Node ID (kebab-case):</label>
            <input type="text" id="new-node-id" placeholder="e.g., my-new-button">
            <label for="new-node-description">Description:</label>
            <textarea id="new-node-description" rows="2" placeholder="A concise description..."></textarea>
            <label for="new-node-type">Node Type:</label>
            <select id="new-node-type">
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="javascript">JavaScript</option>
            </select>
            <button id="create-node-button" class="action-button">Create Node</button>
            <div id="add-node-error" class="modal-error"></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-settings-modal-button">&times;</span>
            <h2>Settings</h2>
            <div class="ai-provider-container">
                <h3>AI Provider</h3>
                <select id="ai-provider-select">
                    <option value="gemini">Google Gemini</option>
                    <option value="nscale">nscale</option>
                </select>
            </div>
            <div id="gemini-settings-container">
                 <h3>Gemini Model</h3>
                 <select id="gemini-model-select">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
                    <option value="gemini-3-flash-preview">Gemini 3 Flash (Preview)</option>
                 </select>
                <div id="gemini-api-key-container" class="api-key-container">
                    <h3>Gemini API Key</h3>
                    <input type="password" id="api-key-input" placeholder="Enter your Gemini API Key here...">
                    <button id="save-api-key-button">Save Key</button>
                    <div id="api-key-status"></div>
                </div>
            </div>
            <div id="nscale-api-key-container" class="api-key-container" style="display: none;">
                <h3>nscale API Key</h3>
                <input type="password" id="nscale-api-key-input" placeholder="Enter your nscale API Key here...">
                <button id="save-nscale-api-key-button">Save Key</button>
                <div id="nscale-api-key-status"></div>
            </div>
            <hr>
            <div id="github-settings-container" class="api-key-container">
                <h3>GitHub Integration</h3>
                <div id="github-pat-form">
                    <label for="github-pat-input">Personal Access Token (repo scope)</label>
                    <input type="password" id="github-pat-input" placeholder="ghp_...">
                    <button id="save-github-pat-button">Connect to GitHub</button>
                </div>
                <div id="github-status"></div>
                <button id="logout-github-button" style="display:none;">Disconnect from GitHub</button>
            </div>
        </div>
    </div>

    <div id="edit-node-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-edit-node-modal-button">&times;</span>
            <h2>Edit Component</h2>
            <label>Node ID</label>
            <input type="text" id="edit-node-id" readonly>
            <label>Type</label>
            <input type="text" id="edit-node-type" readonly>
            <label for="edit-node-description">Description</label>
            <textarea id="edit-node-description" rows="3"></textarea>
            <button id="ai-improve-description-button" class="action-button" style="margin-top: 10px;">AI: Improve Description</button>
            <label for="edit-node-code">Code</label>
            <textarea id="edit-node-code" rows="10"></textarea>
            <div class="button-row">
                <button id="save-edit-node-button" class="action-button">Save & Update Vibe</button>
                <button id="save-as-component-button" class="action-button">Save as Component</button>
            </div>
            <div id="edit-node-error" class="modal-error"></div>
        </div>
    </div>

    <div id="context-component-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-context-modal-button">&times;</span>
            <h2 id="component-modal-title">Add New Component</h2>
            <div class="component-ai-generator">
                <label for="component-ai-prompt-input">Generate with AI:</label>
                <textarea id="component-ai-prompt-input" rows="3" placeholder="e.g., 'a responsive card with an image...'"></textarea>
                <button id="generate-component-button" class="action-button">Generate Component</button>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #4b5263;">
            <label for="component-id-input">Component ID (unique, kebab-case):</label>
            <input type="text" id="component-id-input" placeholder="e.g., responsive-navbar">
            <label for="component-name-input">Display Name:</label>
            <input type="text" id="component-name-input" placeholder="e.g., Responsive Navbar">
            <label for="component-description-input">Description:</label>
            <textarea id="component-description-input" rows="2"></textarea>
            <div class="component-modal-code-fields">
                <div>
                    <label for="component-html-input">HTML Snippet:</label>
                    <textarea id="component-html-input" rows="6"></textarea>
                </div>
                <div>
                    <label for="component-css-input">CSS Snippet:</label>
                    <textarea id="component-css-input" rows="6"></textarea>
                </div>
                <div>
                    <label for="component-js-input">JavaScript Snippet:</label>
                    <textarea id="component-js-input" rows="6"></textarea>
                </div>
            </div>
            <div class="button-row">
                <button id="save-component-button" class="action-button">Save Component</button>
                <button id="delete-component-button" class="action-button danger" style="display: none;">Delete</button>
            </div>
            <div id="component-modal-error" class="modal-error"></div>
        </div>
    </div>

    <div id="global-agent-loader">
        <div class="loading-spinner"></div>
        <div class="loader-text">
            <p id="global-agent-status-text">Agent is working...</p>
            <p id="global-agent-progress-text"></p>
        </div>
    </div>
    
    <div id="ai-project-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="ai-project-edit-modal-title">AI Command</h2>
                <button id="ai-project-edit-close-button" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p>Enter a command to modify the project. The AI will use the selected component as context but can edit any part of the project to achieve your goal.</p>
                <input type="hidden" id="ai-project-edit-node-id">
                <div class="form-group">
                    <label for="ai-project-edit-prompt-input">Your Command:</label>
                    <textarea id="ai-project-edit-prompt-input" rows="4" placeholder="e.g., 'Make all the links in this navigation bar turn red on hover'"></textarea>
                </div>
                <p id="ai-project-edit-error" class="modal-error"></p>
            </div>
            <div class="modal-footer">
                <button id="ai-project-edit-execute-button" class="action-button">Execute Command</button>
            </div>
        </div>
    </div>
    
    <div id="ai-structure-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AI Structure Update</h2>
                <button id="ai-structure-close-button" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p>Describe how you want to change the current Vibe Tree structure. The AI will generate a new tree based on your instructions. This is a powerful tool for refactoring.</p>
                <div class="form-group">
                    <label for="ai-structure-prompt-input">Your Instructions:</label>
                    <textarea id="ai-structure-prompt-input" rows="6" placeholder="e.g., 'Move the 'login-button' node inside the 'user-profile-card' node. Create a new CSS node called 'card-styles' and link it.'"></textarea>
                </div>
                <p id="ai-structure-error" class="modal-error"></p>
            </div>
            <div class="modal-footer">
                <button id="ai-structure-execute-button" class="action-button">Update Structure</button>
            </div>
        </div>
    </div>

    <div id="ai-controls-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ai-controls-modal-title">Generate Controls</h3>
                <span id="ai-controls-close-button" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ai-controls-node-id">
                <p>Describe the controls you want to generate for this element (e.g., "add controls for background color, padding, and font size").</p>
                <textarea id="ai-controls-prompt-input" class="modal-textarea" rows="4" placeholder="Enter your instructions..."></textarea>
                <div id="ai-controls-error" class="modal-error"></div>
            </div>
            <div class="modal-footer">
                <button id="ai-controls-execute-button" class="action-button ai-powered-button">Generate Controls</button>
            </div>
        </div>
    </div>
    
    <div id="github-save-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save Project to GitHub</h2>
                <button id="close-github-save-modal-button" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p>Select a repository and branch to save your project.</p>
                <div class="form-group">
                    <label for="github-save-repo-select">Repository</label>
                    <select id="github-save-repo-select" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label for="github-save-branch-select">Branch</label>
                    <select id="github-save-branch-select" class="form-select"></select>
                </div>
                 <div class="form-group">
                    <label for="github-save-commit-message">Commit Message</label>
                    <input type="text" id="github-save-commit-message">
                </div>
                <p id="github-save-error" class="modal-error"></p>
            </div>
            <div class="modal-footer">
                <button id="execute-github-save-button" class="action-button">Save to GitHub</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="app3.js"></script>
    <script src="automation.js"></script>

    <!-- CODE EXPLORER MODULE SCRIPT -->
    <script>
        class CodeExplorer {
            constructor(containerId, options = {}) {
                this.container = document.getElementById(containerId);
                if (!this.container) return; 
                
                this.options = {
                    onEditRequest: options.onEditRequest || null,
                    ...options
                };

                this.functionRegistry = {};
                this.styleRegistry = {};
                this.functionHistory = [];
                this.historyIndex = -1;
                
                this._initUI();
            }

            analyze(doc) {
                this.functionRegistry = {};
                this.styleRegistry = {};
                
                // Extract Scripts
                Array.from(doc.getElementsByTagName('script')).forEach(script => {
                    if (script.textContent) this._extractFunctions(script.textContent);
                });

                // Extract Styles
                Array.from(doc.getElementsByTagName('style')).forEach(style => {
                    if (style.textContent) this._extractStyles(style.textContent);
                });

                this.outputDiv.innerHTML = `
                    <div class="ce-code-block" style="text-align:center; color:#888; margin-top:20px;">
                        <h3><i class="bi bi-search"></i> Code Explorer Ready</h3>
                        <p>Found ${Object.keys(this.functionRegistry).length} functions and ${Object.keys(this.styleRegistry).length} style rules.</p>
                        <p><strong>Click any element in the preview above to inspect its code.</strong></p>
                    </div>`;
            }

            inspectElement(element) {
                this.functionHistory = [];
                this.historyIndex = -1;
                const content = this._generateElementContent(element);
                
                this._addToHistory({
                    type: 'element',
                    name: element.tagName.toLowerCase(),
                    content: content,
                    element: element
                });
            }

            _initUI() {
                this.container.classList.add('ce-container');
                this.container.innerHTML = `
                    <div class="ce-header">
                        <h4>Code Explorer</h4>
                        <button class="ce-btn-small" id="ce-close-btn" title="Close Panel"><i class="bi bi-x-lg"></i></button>
                    </div>
                    <div class="ce-search-section">
                        <input type="text" class="ce-search-input" placeholder="Search functions...">
                        <button class="ce-btn">Search</button>
                    </div>
                    <div class="ce-results"></div>
                    <div class="ce-output"></div>
                `;

                this.searchInput = this.container.querySelector('.ce-search-input');
                this.searchBtn = this.container.querySelector('.ce-btn');
                this.resultsDiv = this.container.querySelector('.ce-results');
                this.outputDiv = this.container.querySelector('.ce-output');

                this.searchBtn.onclick = () => this._performSearch();
                this.searchInput.onkeyup = (e) => { if(e.key === 'Enter') this._performSearch(); };
                
                this.container.querySelector('#ce-close-btn').onclick = () => {
                    document.getElementById('code-explorer-toggle-btn').click();
                };
            }

            _generateElementContent(element) {
                const tagName = element.tagName.toLowerCase();
                const id = element.id ? `#${element.id}` : '';
                const classes = element.className && typeof element.className === 'string' ? `.${element.className.replace(/\s+/g, '.')}` : '';
                
                let matchedStyles = '';
                for (const selector in this.styleRegistry) {
                    try {
                        if (element.matches && element.matches(selector)) {
                            matchedStyles += `${selector} {\n    ${this.styleRegistry[selector]}\n}\n`;
                        }
                    } catch(e){}
                }

                const relatedFuncs = this._getRelatedFunctions(element);

                return `
                    <div class="ce-code-block">
                        <h3>&lt;${tagName}${id}${classes}&gt;</h3>
                        ${this.options.onEditRequest ? 
                            `<button class="ce-btn-small" style="float:right;" data-action="edit-el">Ask AI to Edit</button>` : ''}
                        <div style="clear:both;"></div>
                        <pre class="ce-code-content">${this._escapeHtml(element.outerHTML.split('>')[0] + '> ...')}</pre>
                    </div>

                    ${matchedStyles ? `
                    <div class="ce-code-block">
                        <h4>CSS Rules</h4>
                        <pre class="ce-code-content ce-css-rules">${this._escapeHtml(matchedStyles)}</pre>
                    </div>` : ''}

                    ${relatedFuncs.length > 0 ? `
                    <div class="ce-code-block">
                        <h4>Event Handlers</h4>
                        <div class="ce-dependency-tree">
                            ${relatedFuncs.map(f => `<span class="ce-function-link" data-fn="${f}">${f}</span>`).join('')}
                        </div>
                    </div>` : ''}
                `;
            }

            _showFunction(name) {
                if (!this.functionRegistry[name]) return;
                const func = this.functionRegistry[name];

                const content = `
                    <div class="ce-code-block">
                        <span class="ce-function-name">${name}()</span>
                        <pre class="ce-code-content">${this._linkifyCode(func.code)}</pre>
                        ${func.dependencies.length ? `
                        <div class="ce-dependency-tree">
                            <h4>Calls:</h4>
                            ${func.dependencies.map(d => `<span class="ce-function-link" data-fn="${d}">${d}</span>`).join('<br>')}
                        </div>` : ''}
                    </div>
                `;

                this._addToHistory({ type: 'function', name: name, content: content });
            }

            _addToHistory(state) {
                if (this.historyIndex < this.functionHistory.length - 1) {
                    this.functionHistory = this.functionHistory.slice(0, this.historyIndex + 1);
                }
                this.functionHistory.push(state);
                this.historyIndex++;
                this._renderCurrentState();
            }

            _renderCurrentState() {
                const state = this.functionHistory[this.historyIndex];
                const nav = `
                    <div class="ce-navigation">
                        <button class="ce-btn-small" id="ce-back-btn" ${this.historyIndex === 0 ? 'disabled' : ''}>← Back</button>
                        <span style="color:#888; font-size:12px;">${state.type.toUpperCase()}: ${state.name}</span>
                    </div>
                `;
                this.outputDiv.innerHTML = nav + state.content;
                this.resultsDiv.innerHTML = ''; 

                this.outputDiv.querySelector('#ce-back-btn').onclick = () => {
                    if (this.historyIndex > 0) {
                        this.historyIndex--;
                        this._renderCurrentState();
                    }
                };
                
                // ENSURE LINKS ARE CLICKABLE
                this.outputDiv.querySelectorAll('.ce-function-link').forEach(el => {
                    el.onclick = () => this._showFunction(el.dataset.fn);
                });
                
                this.outputDiv.querySelectorAll('button[data-action="edit-el"]').forEach(btn => {
                    btn.onclick = () => {
                       const prompt = document.getElementById('ai-project-edit-prompt-input'); 
                       if(prompt) {
                           prompt.value = `Focusing on the <${state.name}> element... `;
                           document.getElementById('ai-project-edit-modal').style.display = 'block';
                       }
                    };
                });
            }

            _extractFunctions(code) {
                const funcRegex = /function\s+(\w+)\s*\([^)]*\)\s*{/g;
                let match;
                while ((match = funcRegex.exec(code)) !== null) {
                    const name = match[1];
                    const body = this._extractCodeBlock(code, code.indexOf('{', match.index));
                    if(body) this.functionRegistry[name] = { code: body, dependencies: this._findDependencies(body) };
                }
            }
            _extractStyles(css) {
                const ruleRegex = /([^{]+)\{([^}]+)\}/g;
                let match;
                while ((match = ruleRegex.exec(css)) !== null) {
                    this.styleRegistry[match[1].trim()] = match[2].trim();
                }
            }
            _extractCodeBlock(code, openIndex) {
                if (openIndex < 0) return null;
                let count = 1, i = openIndex + 1;
                while (count > 0 && i < code.length) {
                    if (code[i] === '{') count++;
                    else if (code[i] === '}') count--;
                    i++;
                }
                return code.substring(openIndex, i + 1);
            }
            _findDependencies(body) {
                return Object.keys(this.functionRegistry).filter(name => body.includes(name + '('));
            }
            _getRelatedFunctions(element) {
                const funcs = [];
                if (element.attributes) {
                    Array.from(element.attributes).forEach(attr => {
                        if (attr.name.startsWith('on')) {
                            const val = attr.value.split('(')[0];
                            if(this.functionRegistry[val]) funcs.push(val);
                        }
                    });
                }
                return funcs;
            }
            _performSearch() {
                const term = this.searchInput.value.toLowerCase();
                if (!term) return;
                let html = '';
                Object.keys(this.functionRegistry).forEach(name => {
                    if (name.toLowerCase().includes(term)) {
                        html += `<div class="ce-search-result" data-fn="${name}"><span class="ce-result-type">FN</span> ${name}</div>`;
                    }
                });
                this.resultsDiv.innerHTML = html || '<div style="padding:5px;">No results</div>';
                this.resultsDiv.querySelectorAll('.ce-search-result').forEach(el => el.onclick = () => this._showFunction(el.dataset.fn));
            }
            _linkifyCode(code) { return this._escapeHtml(code); }
            _escapeHtml(str) { return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        }

        /* --- INTEGRATION LOGIC --- */
        document.addEventListener('DOMContentLoaded', () => {
            const previewIframe = document.getElementById('website-preview');
            const inspectBtn = document.getElementById('code-explorer-toggle-btn');
            const explorerPanel = document.getElementById('explorer-panel');
            const resizer = document.getElementById('preview-resizer');
            const topPane = document.getElementById('preview-top-pane');
            
            let explorer = null;
            let isInspectActive = false;

            // 1. Initialize Explorer
            explorer = new CodeExplorer('explorer-panel', {
                onEditRequest: (type, name, content) => {
                    console.log("Edit requested:", type, name);
                }
            });

            // 2. Setup Interaction Logic (reusable)
            const setupIframeInteraction = (iframe) => {
                if (!isInspectActive) return;
                
                try {
                    const doc = iframe.contentDocument;
                    if (!doc) return;
                    
                    if (doc.hasAttachedVibeInspect) return;
                    doc.hasAttachedVibeInspect = true;

                    // Inject Styles
                    if(!doc.getElementById('ce-injected-styles')) {
                        const style = doc.createElement('style');
                        style.id = 'ce-injected-styles';
                        style.textContent = `
                            .ce-highlight { 
                                outline: 3px solid #0d6efd !important; 
                                cursor: pointer !important;
                                box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
                                z-index: 2147483647;
                            }
                            body { cursor: default; }
                        `;
                        doc.head.appendChild(style);
                    }

                    // Run analysis
                    explorer.analyze(doc);

                    // Attach Listener to Document (captures everything)
                    doc.addEventListener('click', (e) => {
                        if (!isInspectActive) return;
                        e.preventDefault();
                        e.stopPropagation();

                        // Visual Highlight
                        const prev = doc.querySelector('.ce-highlight');
                        if(prev) prev.classList.remove('ce-highlight');
                        
                        let target = e.target;
                        if (target.tagName === 'HTML') target = doc.body;
                        
                        target.classList.add('ce-highlight');

                        // Send to Explorer
                        explorer.inspectElement(target);
                    }, true);

                    // Optional: Hover effect
                     doc.addEventListener('mouseover', (e) => {
                        if (!isInspectActive) return;
                        e.stopPropagation();
                        e.target.style.cursor = 'crosshair';
                    }, true);

                } catch (err) {
                    console.warn("Vibe Code Explorer: Cannot access iframe content (likely cross-origin restriction).", err);
                }
            };

            // 3. Toggle Logic
            inspectBtn.addEventListener('click', () => {
                isInspectActive = !isInspectActive;
                
                if (isInspectActive) {
                    // Activate UI
                    inspectBtn.classList.remove('btn-outline-info');
                    inspectBtn.classList.add('btn-info');
                    inspectBtn.innerHTML = '<i class="bi bi-bug-fill me-1"></i> Disable Inspect';
                    resizer.style.display = 'flex';
                    explorerPanel.classList.add('active');
                    explorerPanel.style.height = '350px';

                    // Attempt attachment immediately
                    setupIframeInteraction(previewIframe);
                } else {
                    // Deactivate UI
                    inspectBtn.classList.add('btn-outline-info');
                    inspectBtn.classList.remove('btn-info');
                    inspectBtn.innerHTML = '<i class="bi bi-bug me-1"></i> Enable Inspect';
                    resizer.style.display = 'none';
                    explorerPanel.classList.remove('active');
                    explorerPanel.style.height = '0px';
                    
                    // Cleanup visual artifacts
                    try {
                        const doc = previewIframe.contentDocument;
                        if(doc) {
                            const prev = doc.querySelector('.ce-highlight');
                            if(prev) prev.classList.remove('ce-highlight');
                            doc.hasAttachedVibeInspect = false;
                        }
                    } catch(e) {}
                }
            });

            // 4. Iframe Load Handler
            previewIframe.addEventListener('load', () => {
                if (isInspectActive) {
                    setupIframeInteraction(previewIframe);
                }
            });

            // 5. Resizer Logic
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                topPane.style.pointerEvents = 'none'; // Prevent iframe capturing mouse
                document.body.style.cursor = 'row-resize';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const containerRect = document.querySelector('.preview-layout-wrapper').getBoundingClientRect();
                const newHeight = containerRect.bottom - e.clientY;
                
                // Constraints
                if (newHeight > 50 && newHeight < containerRect.height - 100) {
                    explorerPanel.style.height = `${newHeight}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    topPane.style.pointerEvents = 'auto'; 
                    document.body.style.cursor = 'default';
                }
            });
        });
    </script>
    
    <!-- VISUAL BUILDER (NO-CODE) INTEGRATION SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const noCodeTabBtn = document.querySelector('.tab-button[data-tab="nocode"]');
            const saveBtn = document.getElementById('nocode-save-btn');
            let editor = null;
            let initialized = false;

            function initGrapesJS() {
                if (initialized) return;
                
                editor = grapesjs.init({
                    container: '#gjs',
                    height: '100%',
                    width: 'auto',
                    fromElement: false,
                    storageManager: false,
                    panels: { defaults: [] }, // Clean UI
                    blockManager: {
                        appendTo: '#gjs',
                    },
                    styleManager: {
                        clearProperties: true,
                    },
                    deviceManager: {
                        devices: [
                            { name: 'Desktop', width: '' },
                            { name: 'Tablet', width: '768px', widthMedia: '992px' },
                            { name: 'Mobile Portrait', width: '320px', widthMedia: '575px' }
                        ]
                    }
                });

                // Customize Panels if desired, or leave clean for "Wix-like" direct interaction
                // Add basic blocks for drag and drop
                editor.BlockManager.add('text', {
                    label: 'Text',
                    content: '<div data-gjs-type="text">Insert your text here</div>',
                    attributes: { class: 'bi bi-fonts' }
                });
                editor.BlockManager.add('image', {
                    label: 'Image',
                    content: { type: 'image' },
                    attributes: { class: 'bi bi-image' }
                });
                editor.BlockManager.add('section', {
                    label: 'Section',
                    content: '<section class="container" style="padding: 20px; min-height: 100px;">Container</section>',
                    attributes: { class: 'bi bi-layout-three-columns' }
                });

                initialized = true;
            }

            // Sync Logic: Vibe -> GrapesJS
            if (noCodeTabBtn) {
                noCodeTabBtn.addEventListener('click', () => {
                    setTimeout(() => {
                        if (!initialized) initGrapesJS();
                        
                        // Grab current code. We rely on the Preview Iframe since it has the rendered result
                        const iframe = document.getElementById('website-preview');
                        if (iframe && iframe.contentDocument) {
                            // Extract HTML/CSS
                            const html = iframe.contentDocument.body.innerHTML;
                            // Styles are harder because they are in <style> tags in head.
                            // We will grab inline styles + body content. 
                            // For full fidelity, we'd need to parse the Vibe Tree, but grabbing preview HTML is a good proxy for "visual editing"
                            const styles = Array.from(iframe.contentDocument.querySelectorAll('style')).map(s => s.innerHTML).join('\n');
                            
                            editor.setComponents(html);
                            editor.setStyle(styles);
                        }
                    }, 100);
                });
            }

            // Sync Logic: GrapesJS -> Vibe
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    if (!editor) return;
                    
                    const html = editor.getHtml();
                    const css = editor.getCss();
                    
                    const fullCode = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Edit</title>
    <style>${css}
/* ... inside  ... */

/* Update the #nocode container to handle the full editor */
#nocode {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
}

#nocode-toolbar {
    height: 50px;
    padding: 0 20px;
    background: #1e1e1e; /* Match VS Code look */
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    z-index: 10;
}

#gjs {
    flex: 1;
    overflow: hidden;
    border: none;
}

/* Overrides for GrapesJS to fit Dark Mode Vibe Theme */
.gjs-pn-panel {
    position: relative; /* Let them flow naturally */
}

/* Fix z-index issues with GrapesJS panels overlapping your main toolbar */
.gjs-cv-canvas {
    width: 100%;
    height: 100%;
    top: 0;
}

/* Make the GrapesJS panels dark */
.gjs-one-bg {
    background-color: #2b2b2b;
}
.gjs-two-color {
    color: #ddd;
}
.gjs-three-bg {
    background-color: #1e1e1e;
    color: #ddd;
}
.gjs-four-color, .gjs-four-color-h:hover {
    color: #0d6efd;
}
</style>
</head>
<body>
${html}
</body>
</html>`;
                    
                    // Push to Full Code Editor
                    const codeEditor = document.getElementById('full-code-editor');
                    if (codeEditor) {
                        codeEditor.value = fullCode;
                        // Trigger update
                        const updateBtn = document.getElementById('update-tree-from-code-button');
                        if (updateBtn) updateBtn.click();
                        
                        alert("Visual changes saved and synchronized with Vibe Editor!");
                    }
                });
            }
        });
    
document.addEventListener('DOMContentLoaded', () => {
        const noCodeTabBtn = document.querySelector('.tab-button[data-tab="nocode"]');
        const saveBtn = document.getElementById('nocode-save-btn');
        let editor = null;
        let initialized = false;

        function initGrapesJS() {
            if (initialized) return;

            editor = grapesjs.init({
                container: '#gjs',
                height: '100%',
                width: 'auto',
                fromElement: false,
                storageManager: { type: null }, // We handle storage manually via Vibe
                
                // LOAD THE FULL PRESET (Wix-like features)
                plugins: ['gjs-preset-webpage'],
                pluginsOpts: {
                    'gjs-preset-webpage': {
                        modalImportTitle: 'Import Code',
                        modalImportLabel: '<div style="margin-bottom: 10px; font-size: 13px;">Paste your HTML/CSS here</div>',
                        modalImportContent: '',
                        importViewerOptions: {
                            readOnly: false,
                            theme: 'hopscotch',
                            autoBeautify: true,
                            autoClose: true,
                            width: '100%',
                            height: '100%'
                        },
                        // Enable standard blocks
                        blocksBasicOpts: { flexGrid: true },
                        navbarOpts: { default: true },
                        countdownOpts: { default: true },
                        formsOpts: { default: true },
                        exportOpts: { default: true },
                        
                        // UI Customization
                        textCleanCanvas: 'Are you sure you want to clear the canvas?',
                        showStylesOnChange: true,
                    }
                },
                
                canvas: {
                    styles: [
                        'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css',
                        'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css'
                    ]
                }
            });

            // CUSTOMIZE UI: Move standard buttons or style them
            editor.on('load', () => {
                // Force dark theme on specific panels if needed
                const pn = editor.Panels;
                
                // Add a "Back to Code" button in the GrapesJS panel if you prefer that over the Vibe tabs
                // (Optional, currently handled by Vibe tabs)
                
                console.log("Visual Builder Initialized");
            });

            initialized = true;
        }

        // --- SYNC LOGIC: VIBE -> GRAPESJS ---
        // When clicking the No-Code tab, load the current site state into the builder
        if (noCodeTabBtn) {
            noCodeTabBtn.addEventListener('click', () => {
                // Use a small timeout to allow the tab to become visible so GrapesJS renders correctly
                setTimeout(() => {
                    if (!initialized) initGrapesJS();
                    
                    // Trigger a refresh of the editor to fix layout glitches on first load
                    editor.refresh();

                    // 1. Get code from the Full Code Editor (source of truth)
                    const codeEditor = document.getElementById('full-code-editor');
                    let currentCode = codeEditor ? codeEditor.value : '';

                    // 2. If code editor is empty, try the Preview Iframe
                    if (!currentCode.trim()) {
                        const iframe = document.getElementById('website-preview');
                        if (iframe && iframe.contentDocument) {
                            currentCode = iframe.contentDocument.documentElement.outerHTML;
                        }
                    }

                    // 3. Load into GrapesJS
                    if (currentCode) {
                        // GrapesJS expects HTML and CSS. We set the whole HTML.
                        // The parser will try to extract styles.
                        editor.setComponents(currentCode);
                        
                        // Optional: If you have separate CSS in your Vibe Tree, you might want to inject it:
                        // editor.setStyle(customCssString);
                    }
                }, 100);
            });
        }

        // --- SYNC LOGIC: GRAPESJS -> VIBE ---
        // When clicking "Save Visual Changes", dump the builder state back to Vibe
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                if (!editor) return;

                // 1. Get HTML and CSS from GrapesJS
                const html = editor.getHtml();
                const css = editor.getCss();

                // 2. Wrap it in a full HTML document structure
                // We assume Bootstrap is used based on the canvas settings
                const fullCode = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Visual Build</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
        ${css}
    
</head>
<body>
    ${html}
    <!-- Bootstrap JS -->
    <\/script>
</body>
</html>`;

                // 3. Push to Full Code Editor
                const codeEditor = document.getElementById('full-code-editor');
                if (codeEditor) {
                    codeEditor.value = fullCode;

                    // 4. Trigger Vibe's "Update Tree" logic
                    // This converts the raw HTML back into Vibe Nodes so the AI agent understands the new structure
                    const updateBtn = document.getElementById('update-tree-from-code-button');
                    if (updateBtn) {
                        updateBtn.click();
                    }

                    alert("Visual changes saved! The Vibe Tree has been updated with your design.");
                    
                    // Switch to preview to see the result rendered by Vibe
                    const previewTabBtn = document.querySelector('.tab-button[data-tab="preview"]');
                    if(previewTabBtn) previewTabBtn.click();
                }
            });
        }
    });
</script>
</body>
</html>
