
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Web Code Explorer - Upload and Analyze</title>
<style>
    /* Update/add responsive styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #1e1e1e;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Update container styles */
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    /* Update sidebar styles */
    .sidebar {
      position: fixed;
      left: -100%;
      top: 0;
      width: min(320px, 90vw);
      height: 100vh;
      background: #2d2d2d;
      transition: left 0.3s ease;
      z-index: 1200;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      padding: 20px;
      box-sizing: border-box;
    }

    .sidebar.open {
      left: 0;
    }

    /* Update playground and preview styles */
    #playgroundContainer,
    #codeDisplayContainer {
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      overflow: auto;
    }

    #preview-frame {
      width: 100%;
      height: calc(100vh - 200px) !important;
      min-height: 400px;
      border: 1px solid #444;
      border-radius: 4px;
      background: white;
      margin-bottom: 20px;
    }

    /* Update chat window styles */
    .chat-window {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: min(350px, 90vw);
      height: min(500px, 80vh);
      background: #2d2d2d;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    /* Update help guide styles */
    .help-guide {
      width: min(800px, 90vw);
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Update modal styles */
    #code-review-modal .code-review-content,
    #global-ai-modal .modal-content,
    #ai-edit-modal .ai-modal-content {
      width: min(90%, 600px);
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Add responsive font sizes */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      h1 { font-size: 1.8em; }
      h2 { font-size: 1.5em; }
      h3 { font-size: 1.2em; }

      .chat-bubble {
        width: 50px;
        height: 50px;
      }

      .chat-bubble svg {
        width: 25px;
        height: 25px;
      }

      .edit-buttons,
      .modal-buttons,
      .code-review-buttons {
        flex-wrap: wrap;
      }

      button {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      .component-library {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }

    /* Add styles for landscape orientation */
    @media (orientation: landscape) and (max-height: 600px) {
      .sidebar {
        padding: 10px;
      }

      #preview-frame {
        height: calc(100vh - 100px) !important;
      }

      .chat-window {
        height: 70vh;
      }
    }

    /* Add flex styles for component sections */
    .component-category {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .component-library {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }

    /* Make forms more responsive */
    .edit-controls,
    .style-controls,
    .config-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
    }

    /* Update draggable element styles */
    .draggable {
      touch-action: none;
      position: relative !important;
      max-width: 100%;
    }

    .resize-handle {
      min-width: 20px;
      min-height: 20px;
    }
    
    /* Base styles from previous version */
    .edit-buttons {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .chat-bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #0078d4;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .chat-bubble svg {
      width: 30px;
      height: 30px;
      fill: white;
    }
    .chat-window {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: min(350px, 90vw);
      height: min(500px, 80vh);
      background: #2d2d2d;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    .chat-header {
      padding: 15px;
      background: #1e1e1e;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-header h3 {
      margin: 0;
      color: #fff;
    }
    .chat-close {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 5px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    .message {
      margin-bottom: 15px;
      max-width: 80%;
    }
    .message.user {
      margin-left: auto;
      background: #0078d4;
      color: white;
      padding: 10px;
      border-radius: 15px 15px 0 15px;
    }
    .message.assistant {
      margin-right: auto;
      background: #3d3d3d;
      color: white;
      padding: 10px;
      border-radius: 15px 15px 15px 0;
    }
    .chat-input {
      padding: 15px;
      border-top: 1px solid #444;
      display: flex;
      gap: 10px;
    }
    .chat-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #fff;
    }
    .chat-input button {
      padding: 8px 15px;
    }
    .loading-dots {
      display: inline-block;
    }
    .loading-dots:after {
      content: '.';
      animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots {
      0%, 20% {
        content: '.';
      }
      40% {
        content: '..';   
      }
      60% {
        content: '...';
      }
      80%, 100% {
        content: '';
      }
    }
    .chat-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 999;
    }
    .chat-overlay.open {
      display: block;
    }
    .download-button {
      margin-bottom: 15px;
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .download-button:hover {
      background: #218838;
    }
    /* AI Edit Modal Styles */
    #ai-edit-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }
    #ai-edit-modal .ai-modal-content {
      background-color: #2d2d2d;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: min(90%, 500px);
      max-width: 500px;
      border-radius: 8px;
      color: #fff;
    }
    #ai-edit-modal .ai-modal-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    #ai-edit-modal .ai-modal-close:hover,
    #ai-edit-modal .ai-modal-close:focus {
      color: #fff;
      text-decoration: none;
      cursor: pointer;
    }
    #ai-edit-modal textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #fff;
      resize: vertical;
    }
    #ai-edit-modal .ai-modal-buttons {
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #ai-edit-modal .ai-modal-buttons button {
      padding: 10px 20px;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #ai-edit-modal .ai-modal-buttons button:hover {
      background: #005a9e;
    }
    #ai-edit-loader {
      margin-left: 10px;
    }
    /* Add new styles for the global edit feature */
    #global-ai-edit {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 15px 25px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #global-ai-edit:hover {
      background: #218838;
    }

    #global-ai-edit .loader {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    #global-ai-edit.processing {
      pointer-events: none;
      opacity: 0.8;
    }

    #global-ai-edit.processing .loader {
      display: inline-block;
    }

    #global-ai-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
    }

    #global-ai-modal .modal-content {
      background-color: #2d2d2d;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: min(90%, 600px);
      max-width: 600px;
      border-radius: 8px;
      color: #fff;
    }

    #global-ai-modal textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #fff;
      margin: 15px 0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      resize: vertical;
    }

    #global-ai-modal .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .changes-summary {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      font-family: monospace;
      white-space: pre-wrap;
      display: none;
    }

    .changes-summary.show {
      display: block;
    }
    
    /* Add styles for edit mode */
    .code-editor {
      display: none;
      margin: 10px 0;
    }
    .code-editor textarea {
      width: 100%;
      min-height: 200px;
      font-family: 'Consolas', monospace;
      background: #1e1e1e;
      color: #fff;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
    }
    .editing .code-content {
      display: none;
    }
    .editing .code-editor {
      display: block;
    }
  
  /* Add this to your existing CSS */
.iframe-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 100;
    display: none;
}

.edit-mode-active .iframe-overlay {
    display: block;
}
    /* Originally a grid layout - now overridden below for full screen toggling */
    /* Give each view full viewport height */
    /* Same styles as before */
    .playground {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: auto;
      min-height: 100vh;
    }
    .code-display {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 8px;
      overflow-y: auto;
    }
    .code-block {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-family: 'Consolas', monospace;
    }
    .function-name {
      color: #569cd6;
    }
    .code-content {
      color: #ce9178;
    }
    .dependency-tree {
      margin-left: 20px;
      border-left: 1px solid #569cd6;
      padding-left: 10px;
    }
    .css-rules {
      color: #b5cea8;
      margin-top: 10px;
    }
    .event-handlers {
      color: #dcdcaa;
      margin-top: 10px;
    }
    .js-references {
      margin-top: 20px;
      padding: 10px;
      background: #1e1e1e;
      border-radius: 4px;
    }
    .js-references pre {
      margin: 10px 0;
      padding: 10px;
      background: #2d2d2d;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #005a9e;
    }
    .highlight {
      background: #264f78;
      transition: background 0.3s;
    }
    #upload-section {
      margin-bottom: 20px;
    }
    #previewConsole {
      height: 20vh; 
      background: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 0.85em;
      padding: 10px;
      margin-top: 10px;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 4px;
    }
    .console-entry {
      margin-bottom: 5px;
    }
    .console-entry.error {
      color: #ff5555;
    }
    .console-entry.warn {
      color: #ffbb33;
    }
    .console-entry.info {
      color: #55ddff;
    }
    .dropzone {
      border: 2px dashed #666;
      padding: 20px;
      text-align: center;
      margin: 10px 0;
      border-radius: 4px;
    }
    .dropzone.dragover {
      border-color: #0078d4;
      background: rgba(0, 120, 212, 0.1);
    }
    .search-section {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    #searchInput {
      flex: 1;
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #fff;
    }
    #searchType {
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #fff;
    }
    .search-result {
      padding: 10px;
      margin: 5px 0;
      background: #2d2d2d;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .search-result:hover {
      background: #3d3d3d;
    }
    .result-type {
      color: #569cd6;
      font-size: 0.9em;
      margin-right: 10px;
    }
    .result-name {
      color: #ce9178;
    }
    .function-link {
      color: #4fc3f7;
      text-decoration: underline;
      cursor: pointer;
    }
    .function-link:hover {
      color: #81d4fa;
    }
    .navigation-controls {
      margin-bottom: 15px;
    }
    .nav-button {
      padding: 8px 16px;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .nav-button:hover:not([disabled]) {
      background: #005a9e;
    }
    .nav-button[disabled] {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .edit-controls {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .edit-prompt {
      flex: 1;
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #fff;
    }
    .loader {
      display: none;
      width: 24px;
      height: 24px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader.active {
      display: inline-block;
    }
    /* Add styles for edit mode */
    .code-editor {
      display: none;
      margin: 10px 0;
    }
    .code-editor textarea {
      width: 100%;
      min-height: 200px;
      font-family: 'Consolas', monospace;
      background: #1e1e1e;
      color: #fff;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
    }
    .editing .code-content {
      display: none;
    }
    .editing .code-editor {
      display: block;
    }
    /* Add styles for global ai edit modal close button */
    #global-ai-modal .modal-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      margin-top: -10px;
    }
    #global-ai-modal .modal-close:hover,
    #global-ai-modal .modal-close:focus {
      color: #fff;
      text-decoration: none;
    }
    
    /* Add styles for file browser and zip upload */
    .file-browser {
      background: #2d2d2d;
      border-radius: 8px;
      margin-bottom: 20px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .file-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    
    .file-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }
    
    .file-item:hover {
      background: #3d3d3d;
    }
    
    .file-item.active {
      background: #0078d4;
    }
    
    .file-icon {
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }
    
    .file-tree {
      font-family: monospace;
    }
    
    .file-tree-folder {
      margin-left: 15px;
    }
    
    .zip-upload-message {
      text-align: center;
      padding: 10px;
      margin-top: 10px;
      color: #4fc3f7;
    }
    
    /* Add new styles for draggable/resizable elements */
    /* Add new styles for drag and resize functionality */
    .draggable {
      position: relative !important;
      user-select: none;
      touch-action: none;
    }

    .draggable:hover {
      outline: 2px dashed #0078d4;
    }

    .draggable.dragging {
      opacity: 0.8;
      z-index: 1000;
    }

    .resize-handle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: #0078d4;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1001;
    }

    .draggable:hover .resize-handle {
      opacity: 0.8;
    }

    .resize-handle.top-left { top: -10px; left: -10px; cursor: nw-resize; }
    .resize-handle.top-right { top: -10px; right: -10px; cursor: ne-resize; }
    .resize-handle.bottom-left { bottom: -10px; left: -10px; cursor: sw-resize; }
    .resize-handle.bottom-right { bottom: -10px; right: -10px; cursor: se-resize; }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .resize-handle {
        width: 30px;
        height: 30px;
        opacity: 0.8;
      }
      
      .resize-handle.top-left { top: -15px; left: -15px; }
      .resize-handle.top-right { top: -15px; right: -15px; }
      .resize-handle.bottom-left { bottom: -15px; left: -15px; }
      .resize-handle.bottom-right { bottom: -15px; right: -15px; }
    }
    
    .resize-control-panel {
      position: relative;
      background: #1e1e1e;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
      padding: 15px;
    }

    .resize-control-panel.active {
      display: block;
    }

    .dimension-group {
      margin-bottom: 15px;
    }

    .style-controls {
      margin-top: 15px;
      border-top: 1px solid #444;
      padding-top: 15px;
    }

    .style-group {
      margin-bottom: 10px;
    }

    .style-group label {
      display: block;
      margin-bottom: 5px;
    }

    .style-group input, .style-group select {
      width: 100%;
      padding: 5px;
      background: #2d2d2d;
      border: 1px solid #444;
      color: #fff;
      border-radius: 4px;
    }

    .color-picker {
      width: 100%;
      height: 40px;
      padding: 5px;
      background: #2d2d2d;
      border: 1px solid #444;
      border-radius: 4px;
    }
    /* Add new styles for the sidebar */
    .sidebar {
      position: fixed;
      left: -100%;
      top: 0;
      width: min(320px, 90vw);
      height: 100vh;
      background: #2d2d2d;
      transition: left 0.3s ease;
      z-index: 1200;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      padding: 20px;
      box-sizing: border-box;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-toggle {
      position: fixed;
      left: 20px;
      top: 20px;
      z-index: 1201;
      background: #0078d4;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .sidebar-toggle svg {
      width: 20px;
      height: 20px;
      transition: transform 0.3s;
    }

    .sidebar.open + .sidebar-toggle svg {
      transform: rotate(180deg);
    }

    /* Update container padding to accommodate sidebar */
    .container {
      padding-left: 60px !important;
    }

    /* Section titles */
    .sidebar-section {
      margin-bottom: 20px;
    }

    .sidebar-section-title {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .sidebar-section-content {
      display: none;
      transition: all 0.3s ease;
    }

    .sidebar-section.expanded .sidebar-section-content {
      display: block;
    }

    .collapse-icon {
      cursor: pointer;
      transition: transform 0.3s;
    }

    .sidebar-section.expanded .collapse-icon {
      transform: rotate(180deg);
    }

    /* Tool toggle styles */
    .tool-toggle {
      padding: 10px;
      background: #1e1e1e;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .tool-toggle label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .tool-toggle input[type="checkbox"] {
      margin: 0;
    }

    /* Dimension controls */
    .dimension-group {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 10px;
    }

    .dimension-group label {
      min-width: 50px;
    }

    .dimension-group input {
      width: 60px;
      padding: 5px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2d2d2d;
      color: #fff;
    }

    .dimension-group select {
      padding: 5px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2d2d2d;
      color: #fff;
    }

    /* Component Library Styles */
    .component-library {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .component-category {
      width: 100%;
      margin-bottom: 15px;
    }

    .component-category-title {
      font-size: 0.9em;
      font-weight: bold;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid #444;
    }

    .component-item {
      background: #3d3d3d;
      border-radius: 4px;
      padding: 8px;
      cursor: grab;
      transition: transform 0.2s, background 0.2s;
      text-align: center;
    }

    .component-item:hover {
      background: #0078d4;
      transform: translateY(-2px);
    }

    .component-preview {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .component-name {
      font-size: 0.8em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .drop-indicator {
      position: absolute;
      border: 2px dashed #0078d4;
      background: rgba(0, 120, 212, 0.1);
      z-index: 1000;
      pointer-events: none;
      display: none;
    }

    .drop-indicator.active {
      display: block;
    }

    .component-library-toggle,
    .component-library-window {
      display: none;
    }

    .component-tabs {
      display: flex;
      border-bottom: 1px solid #444;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .component-tab {
      padding: 8px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-size: 0.9em;
    }

    .component-tab.active {
      border-bottom: 2px solid #0078d4;
      color: #0078d4;
    }
    /* Edit mode controls */
    .edit-mode-controls {
      position: fixed;
      bottom: 20px;
      right: 100px;
      display: flex;
      gap: 10px;
      z-index: 1000;
    }

    .edit-mode-button {
      padding: 10px 15px;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .edit-mode-button.active {
      background: #28a745;
    }

    .edit-mode-button.delete {
      background: #dc3545;
    }

    .element-delete-handle {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 20px;
      height: 20px;
      background: #dc3545;
      border-radius: 50%;
      display: none;
      cursor: pointer;
      z-index: 1002;
    }

    .draggable:hover .element-delete-handle {
      display: block;
    }

    .edit-mode-active .draggable {
      outline: 2px dashed #0078d4;
    }

    .edit-mode-active .draggable:hover .resize-handle,
    .edit-mode-active .draggable:hover .element-delete-handle {
      opacity: 1;
    }
    .color-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .transparency-control {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .transparency-control label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .transparency-control input[type="range"] {
      flex: 1;
      min-width: 100px;
    }

    #opacityValue {
      min-width: 48px;
    }
    
    /* New styles for element type controls */
    .element-type {
      padding: 5px 10px;
      background: #444;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 0.9em;
    }

    .element-type-controls {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #444;
    }

    .image-preview {
      max-width: 100%;
      height: 100px;
      background: #333;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    /* Add new styles for code review modal */
    #code-review-modal {
      display: none;
      position: fixed;
      z-index: 2100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      overflow: auto;
    }

    .code-review-content {
      background-color: #2d2d2d;
      margin: 2% auto;
      padding: 20px;
      width: min(90%, 600px);
      height: 85vh;
      border-radius: 8px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #code-editor {
      width: 100%;
      height: calc(100% - 60px);
      border-radius: 4px;
      margin-bottom: 15px;
      border: 1px solid #444;
    }

    .code-review-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .code-review-close {
      position: absolute;
      right: 20px;
      top: 10px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .code-review-close:hover {
      color: #fff;
    }
    #slashRemovalReport {
      font-family: monospace;
      font-size: 0.9em;
      color: #4fc3f7;
      white-space: pre-wrap;
      word-break: break-word;
    }
  
    .code-review-buttons button {
      margin-right: 10px;
      padding: 8px 16px;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
  
    .code-review-buttons button:hover {
      background: #005a9e;
    }
    /* Add new styles for the help guide */
    .help-guide {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(800px, 90vw);
      max-height: 90vh;
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      z-index: 2200;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      overflow-y: auto;
    }

    .help-guide.open {
      display: block;
    }

    .help-guide h2 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #444;
    }

    .help-guide-section {
      margin: 20px 0;
    }

    .help-guide-section h3 {
      color: #0078d4;
      margin-bottom: 10px;
    }

    .help-guide-section ul {
      list-style-type: none;
      padding-left: 0;
    }

    .help-guide-section li {
      margin: 10px 0;
      padding-left: 20px;
      position: relative;
    }

    .help-guide-section li:before {
      content: "‚Ä¢";
      color: #0078d4;
      position: absolute;
      left: 0;
      top: 0;
    }

    .help-guide .close-button {
      position: absolute;
      right: 20px;
      top: 20px;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }

    .help-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: #0078d4;
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      margin: 10px auto;
      transition: background 0.3s;
    }

    .help-button:hover {
      background: #005a9e;
    }

    .help-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2100;
    }

    .help-overlay.open {
      display: block;
    }
    /* Add styles for create new section */
    .create-new-section {
      padding: 15px;
      margin: 15px 0;
      background: #2d2d2d;
      border-radius: 8px;
      display: none; /* Hidden by default, shown when no project */
    }

    .create-new-section.show {
      display: block;
    }

    .create-new-section h3 {
      margin: 0 0 10px 0;
      color: #fff;
    }

    .create-new-section p {
      color: #aaa;
      font-size: 0.9em;
      margin-bottom: 15px;
    }

    .create-new-section textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      margin-bottom: 10px;
      background: #1e1e1e;
      border: 1px solid #444;
      border-radius: 4px;
      color: #fff;
      font-family: inherit;
      resize: vertical;
    }

    .create-new-section button {
      width: 100%;
      padding: 10px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .create-new-section button:hover {
      background: #218838;
    }

    .create-new-section button.generating {
      background: #666;
      cursor: not-allowed;
    }

    .create-new-section .loader {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .create-new-section button.generating .loader {
      display: inline-block;
    }
    .api-config {
      padding: 15px;
      background: #1e1e1e;
      border-radius: 4px;
      margin-top: 10px;
    }

    .config-group {
      margin-bottom: 15px;
    }

    .config-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 0.9em;
    }

    .config-group input {
      width: 100%;
      padding: 8px;
      background: #2d2d2d;
      border: 1px solid #444;
      color: #fff;
      font-family: inherit;
    }

    .save-config-button {
      width: 100%;
      padding: 10px;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .save-config-button:hover {
      background: #005a9e;
    }

    .api-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9em;
      display: none;
    }

    .api-status.success {
      display: block;
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
    }

    .api-status.error {
      display: block;
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
    }
    /* Add these styles to your existing CSS */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      pointer-events: none;
    }
    
    .toast {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 20px;
      margin: 10px;
      text-align: center;
      animation: toast-in 0.3s ease-out;
    }
    
    .toast.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }
    
    @keyframes toast-in {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Update component items to be more tap-friendly on mobile */
    @media (max-width: 768px) {
      .component-item {
        padding: 15px;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      .component-item:active {
        transform: scale(0.95);
        background: #005a9e;
      }
      
      .component-preview {
        font-size: 24px;
      }
      
      .component-name {
        font-size: 0.9em;
        margin-top: 5px;
      }
    }

    /* === NEW STYLES FOR AUTH & PROJECT BROWSER === */
    /* User Controls */
    #user-controls {
      padding: 10px 20px;
      background: #1e1e1e;
      border-bottom: 1px solid #444;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    #user-info {
      font-weight: bold;
      margin-right: auto;
    }

    /* General Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }
    .modal-overlay .modal-content {
      background-color: #2d2d2d;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: min(90%, 500px);
      border-radius: 8px;
      color: #fff;
      position: relative;
    }
    .modal-overlay .modal-close {
      color: #aaa;
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .error-message { color: #dc3545; }
    .success-message { color: #28a745; }

    #auth-form-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Project List Styles */
    #project-list-container {
      max-height: 40vh;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
    }
    .project-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #3d3d3d;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .project-item-name {
      font-weight: bold;
    }
    .project-item-actions button {
      margin-left: 5px;
      padding: 5px 10px;
      font-size: 0.8em;
    }
    .project-item-actions button.delete {
        background-color: #dc3545;
    }
    .project-item-actions button.delete:hover {
        background-color: #c82333;
    }
</style>
</head>
<body>
<div class="sidebar">
  <div id="user-controls">
    <span id="user-info" style="display: none;"></span>
    <button id="auth-button">Login</button>
    <button id="logout-button" style="display: none;">Logout</button>
    <button id="projects-button" style="display: none;">My Projects</button>
    <button id="save-project-button" style="display: none;">Save Project</button>
  </div>
<div class="create-new-section">
  <h3 id="websiteActionTitle">Create New Website</h3>
  <p id="websiteActionDescription">Describe the website you want to create and AI will generate it for you.</p>
  <textarea id="websitePrompt" placeholder="Example: Create a modern portfolio website with a hero section, about me, skills, and contact form. Use a dark theme with blue accents..."></textarea>
  <button id="generateButton">
    <span id="actionButtonText">Generate Website</span>
    <div class="loader"></div>
  </button>
</div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">
      API Configuration
      <span class="collapse-icon">‚ñº</span>
    </div>  
    <div class="sidebar-section-content">
      <div class="api-config">
        <div class="config-group">
          <label for="apiKey">Gemini API Key:</label>
          <input type="password" id="apiKey" placeholder="Enter your Gemini API key">
        </div>
        <button id="save-config-button" class="save-config-button">Save Configuration</button>
        <div class="api-status"></div>
      </div>
    </div>
  </div>
  <button class="help-button" id="help-button">?</button>
  <div class="sidebar-section expanded">
    <div class="sidebar-section-title">
      Upload Project
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="sidebar-section-content">
      <div id="upload-section">
        <div class="dropzone" id="dropzone">
          Drag &amp; drop HTML file or ZIP archive here or
          <input type="file" id="fileInput" accept=".html,.htm,.zip" style="display: none;">
          <button id="browse-files-button">Browse</button>
        </div>
        <div class="zip-upload-message" id="zipUploadMessage"></div>
      </div>
    </div>
  </div>

  <div class="sidebar-section expanded">
    <div class="sidebar-section-title">
      Project Files
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="sidebar-section-content">
          <button id="editCodeButton" class="download-button">Edit Code</button>
      <div class="file-browser" id="fileBrowser">
        <div class="file-tree" id="fileTree"></div>
      </div>
    </div>
  </div>

  <div class="sidebar-section expanded">
    <div class="sidebar-section-title">
      Element Tools
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="sidebar-section-content">
      <div class="tool-toggle">
        <label>
          <input type="checkbox" id="toggleMoveElements"> Enable Element Movement
        </label>
      </div>
      <div class="resize-control-panel">
        <div class="dimension-group">
          <label>Width:</label>
          <input type="number" id="elementWidth" min="0" step="1">
          <select id="widthUnit">
            <option value="px">px</option>
            <option value="%">%</option>
            <option value="vw">vw</option>
          </select>
        </div>
        <div class="dimension-group">
          <label>Height:</label>
          <input type="number" id="elementHeight" min="0" step="1">
          <select id="heightUnit">
            <option value="px">px</option>
            <option value="%">%</option>
            <option value="vh">vh</option>
          </select>
        </div>
        <button id="apply-dimensions-button">Apply Dimensions</button>
        
        <div class="style-controls">
          <div class="style-group">
            <label>Background Color:</label>
            <div class="color-controls">
              <input type="color" id="elementBgColor" class="color-picker">
              <div class="transparency-control">
                <label>
                  <input type="checkbox" id="transparentBg"> Transparent
                </label>
                <input type="range" id="bgOpacity" min="0" max="100" value="100" disabled>
                <span id="opacityValue">100%</span>
              </div>
            </div>
          </div>
          <div class="style-group">
            <label>Text Color:</label>
            <input type="color" id="elementTextColor" class="color-picker">
          </div>
          <div class="style-group">
            <label>Font Size:</label>
            <input type="number" id="elementFontSize" min="0" step="1">
            <select id="fontSizeUnit">
              <option value="px">px</option>
              <option value="em">em</option>
              <option value="rem">rem</option>
            </select>
          </div>
          <div class="style-group">
            <label>Font Family:</label>
            <select id="elementFontFamily">
              <option value="inherit">Default</option>
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Times New Roman', serif">Times New Roman</option>
              <option value="'Courier New', monospace">Courier New</option>
              <option value="Georgia, serif">Georgia</option>
              <option value="Verdana, sans-serif">Verdana</option>
            </select>
          </div>
          <div class="style-group">
            <label>Text Content:</label>
            <input type="text" id="elementTextContent" placeholder="Enter text...">
          </div>
          <div class="style-group">
            <label>Element Type:</label>
            <div id="elementTypeIndicator" class="element-type"></div>
          </div>
          <div id="imageControls" class="element-type-controls" style="display:none;">
            <div class="style-group">
              <label>Replace Image:</label>
              <input type="file" id="imageUpload" accept="image/*">
              <div class="image-preview"></div>
            </div>
            <div class="style-group">
              <label>Alt Text:</label>
              <input type="text" id="imageAlt" placeholder="Describe the image...">
            </div>
          </div>

          <div id="linkControls" class="element-type-controls" style="display:none;">
            <div class="style-group">
              <label>Link URL:</label>
              <input type="url" id="linkUrl" placeholder="https://...">
            </div>
            <div class="style-group">
              <label>Open in new tab:</label>
              <input type="checkbox" id="linkNewTab">
            </div>
          </div>

          <div id="buttonControls" class="element-type-controls" style="display:none;">
            <div class="style-group">
              <label>Button Type:</label>
              <select id="buttonType">
                <option value="button">Button</option>
                <option value="submit">Submit</option>
                <option value="reset">Reset</option>
              </select>
            </div>
          </div>

          <div id="inputControls" class="element-type-controls" style="display:none;">
            <div class="style-group">
              <label>Input Type:</label>
              <select id="inputType">
                <option value="text">Text</option>
                <option value="password">Password</option>
                <option value="email">Email</option>
                <option value="number">Number</option>
                <option value="tel">Phone</option>
                <option value="date">Date</option>
              </select>
            </div>
            <div class="style-group">
              <label>Placeholder:</label>
              <input type="text" id="inputPlaceholder" placeholder="Enter placeholder text...">
            </div>
          </div>
          <button id="apply-styles-button">Apply Styles</button>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar-section expanded">
    <div class="sidebar-section-title">
      Component Library
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="sidebar-section-content">
      <div class="component-tabs">
        <div class="component-tab active" data-tab="basic">Basic</div>
        <div class="component-tab" data-tab="forms">Forms</div>
        <div class="component-tab" data-tab="media">Media</div>
        <div class="component-tab" data-tab="layout">Layout</div>
      </div>
      <div class="component-library-content">
        <div class="component-category" data-category="basic">
          <div class="component-category-title">Basic Elements</div>
          <div class="component-library">
            <div class="component-item" draggable="true" data-type="heading" data-content="<h1>Heading</h1>">
              <div class="component-preview">H1</div>
              <div class="component-name">Heading</div>
            </div>
            <div class="component-item" draggable="true" data-type="paragraph" data-content="<p>Paragraph text</p>">
              <div class="component-preview">P</div>
              <div class="component-name">Paragraph</div>
            </div>
            <div class="component-item" draggable="true" data-type="button" data-content="<button>Button</button>">
              <div class="component-preview">Btn</div>
              <div class="component-name">Button</div>
            </div>
            <div class="component-item" draggable="true" data-type="link" data-content="<a href='#'>Link</a>">
              <div class="component-preview">A</div>
              <div class="component-name">Link</div>
            </div>
            <div class="component-item" draggable="true" data-type="list" data-content="<ul><li>Item 1</li><li>Item 2</li></ul>">
              <div class="component-preview">UL</div>
              <div class="component-name">List</div>
            </div>
            <div class="component-item" draggable="true" data-type="divider" data-content="<hr>">
              <div class="component-preview">HR</div>
              <div class="component-name">Divider</div>
            </div>
          </div>
        </div>

        <div class="component-category" data-category="forms" style="display:none;">
          <div class="component-category-title">Form Elements</div>
          <div class="component-library">
            <div class="component-item" draggable="true" data-type="form" data-content="<form><input type='text' placeholder='Name'><button type='submit'>Submit</button></form>">
              <div class="component-preview">Form</div>
              <div class="component-name">Form</div>
            </div>
            <div class="component-item" draggable="true" data-type="input" data-content="<input type='text' placeholder='Text input'>">
              <div class="component-preview">Input</div>
              <div class="component-name">Text Input</div>
            </div>
            <div class="component-item" draggable="true" data-type="textarea" data-content="<textarea placeholder='Textarea'></textarea>">
              <div class="component-preview">Textarea</div>
              <div class="component-name">Textarea</div>
            </div>
            <div class="component-item" draggable="true" data-type="select" data-content="<select><option>Option 1</option><option>Option 2</option></select>">
              <div class="component-preview">Select</div>
              <div class="component-name">Dropdown</div>
            </div>
            <div class="component-item" draggable="true" data-type="checkbox" data-content="<label><input type='checkbox'> Checkbox</label>">
              <div class="component-preview">‚úì</div>
              <div class="component-name">Checkbox</div>
            </div>
            <div class="component-item" draggable="true" data-type="radio" data-content="<label><input type='radio' name='group'> Option</label>">
              <div class="component-preview">‚óã</div>
              <div class="component-name">Radio</div>
            </div>
          </div>
        </div>

        <div class="component-category" data-category="media" style="display:none;">
          <div class="component-category-title">Media Elements</div>
          <div class="component-library">
            <div class="component-item" draggable="true" data-type="image" data-content="<img src='https://via.placeholder.com/150' alt='Image'>">
              <div class="component-preview">üñºÔ∏è</div>
              <div class="component-name">Image</div>
            </div>
            <div class="component-item" draggable="true" data-type="video" data-content="<video controls width='250'><source src='' type='video/mp4'></video>">
              <div class="component-preview">üé¨</div>
              <div class="component-name">Video</div>
            </div>
            <div class="component-item" draggable="true" data-type="audio" data-content="<audio controls><source src='' type='audio/mpeg'></audio>">
              <div class="component-preview">üéµ</div>
              <div class="component-name">Audio</div>
            </div>
            <div class="component-item" draggable="true" data-type="iframe" data-content="<iframe src='' width='300' height='150'></iframe>">
              <div class="component-preview">üì∫</div>
              <div class="component-name">Embed</div>
            </div>
          </div>
        </div>

        <div class="component-category" data-category="layout" style="display:none;">
          <div class="component-category-title">Layout Elements</div>
          <div class="component-library">
            <div class="component-item" draggable="true" data-type="container" data-content="<div style='padding: 20px; border: 1px dashed #ccc;'></div>">
              <div class="component-preview">üì¶</div>
              <div class="component-name">Container</div>
            </div>
            <div class="component-item" draggable="true" data-type="row" data-content="<div style='display: flex; gap: 10px; padding: 10px;'></div>">
              <div class="component-preview">‚ÜîÔ∏è</div>
              <div class="component-name">Row</div>
            </div>
            <div class="component-item" draggable="true" data-type="column" data-content="<div style='padding: 10px;'></div>">
              <div class="component-preview">‚ÜïÔ∏è</div>
              <div class="component-name">Column</div>
            </div>
            <div class="component-item" draggable="true" data-type="card" data-content="<div style='border: 1px solid #ccc; border-radius: 8px; padding: 15px;'></div>">
              <div class="component-preview">üÉè</div>
              <div class="component-name">Card</div>
            </div>
            <div class="component-item" draggable="true" data-type="hero" data-content="<div style='background: #f0f0f0; padding: 40px; text-align: center;'><h1>Hero Section</h1><p>Welcome message</p></div>">
              <div class="component-preview">üåü</div>
              <div class="component-name">Hero</div>
            </div>
            <div class="component-item" draggable="true" data-type="footer" data-content="<footer style='background: #333; color: white; padding: 20px; text-align: center;'>Footer content</footer>">
              <div class="component-preview">‚¨áÔ∏è</div>
              <div class="component-name">Footer</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <div class="code-display" id="codeDisplayContainer" style="display: none;">
    <h2>Code Explorer</h2>
    <button id="download-code-button" class="download-button">Download Updated Code</button>
    <div class="search-section">
      <input type="text" id="searchInput" placeholder="Search for elements or functions...">
      <select id="searchType">
        <option value="all">All</option>
        <option value="elements">Elements</option>
        <option value="functions">Functions</option>
      </select>
      <button id="search-button">Search</button>
    </div>
    <div id="searchResults"></div>
    <div id="codeOutput"></div>
  </div>

  
</div>

<button class="sidebar-toggle">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M9 18l6-6-6-6"/>
  </svg>
</button>

<!-- Container for playground and code display -->
<div class="container">
  <!-- Playground container: visible by default -->
  <div class="playground" id="playgroundContainer" style="display: flex;">
    <div style="position: relative;">
      <iframe id="preview-frame" sandbox="allow-same-origin allow-scripts"></iframe>
      <div class="iframe-overlay"></div>
    </div>  
    <!-- New Console Log Interface -->
    <div id="previewConsole"></div>
  </div>
  <!-- Code display container: hidden by default -->
</div>
  
<!-- Toggle view button -->
<button id="toggleViewButton" class="toggle-button">Switch to Code Explorer</button>

<!-- Edit mode controls -->
<div class="edit-mode-controls">
  <button id="toggleEditMode" class="edit-mode-button">Edit Mode</button>
  <button id="deleteElementButton" class="edit-mode-button delete" disabled>Delete Element</button>
</div>
  
<div class="chat-bubble">
  <svg viewBox="0 0 24 24">
    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
  </svg>
</div>
  
<div class="chat-window">
  <div class="chat-header">
    <h3>Website Assistant</h3>
    <button class="chat-close">&#xd7;</button>
  </div>
  <div class="chat-messages"></div>
  <div class="chat-input">
    <input type="text" placeholder="Ask a question about the website...">
    <button>Send</button>
  </div>
</div>
  
<!-- AI Edit Modal -->
<div id="ai-edit-modal">
  <div class="ai-modal-content">
    <span class="ai-modal-close">&times;</span>
    <h2>Edit Function with AI</h2>
    <p>Enter instructions for editing the function: <span id="ai-function-name"></span></p>
    <textarea id="ai-edit-instructions" placeholder="Type your instructions here..."></textarea>
    <div class="ai-modal-buttons">
      <button id="ai-edit-submit-button">Submit</button>
      <button id="ai-edit-cancel-button">Cancel</button>
      <div class="loader" id="ai-edit-loader"></div>
    </div>
  </div>
</div>
  
<!-- Add new button for global AI edit -->
<button id="global-ai-edit">
  <span>AI Edit Website</span>
  <div class="loader"></div>
</button>

<!-- Add new modal for global AI edit -->
<div id="global-ai-modal">
  <div class="modal-content">
    <span class="modal-close" id="global-ai-modal-close">&times;</span>
    <h2>Edit Website with AI</h2>
    <p>Describe what changes you want to make to the website:</p>
    <textarea id="global-ai-instructions" placeholder="Example: Add a dark mode toggle button in the top right corner, or Make the search input wider and add a clear button..."></textarea>
    <div class="changes-summary"></div>
    <div class="modal-buttons">
      <button id="global-ai-cancel-button">Cancel</button>
      <button id="global-ai-apply-button">Apply Changes</button>
    </div>
  </div>
</div>

<!-- Drop indicator for component placement -->
<div class="drop-indicator"></div>

<!-- Add code review modal -->
<div id="code-review-modal">
  <div class="code-review-content">
    <span class="code-review-close">&times;</span>
    <h2>Review and Edit Code</h2>
    <div class="code-review-buttons" style="margin-bottom: 10px;">
      <button id="save-code-changes-button">Save Changes</button>

      <button id="remove-slashes-button">Remove Leading Slashes</button>
      <div id="slashRemovalReport" style="display: none; margin: 10px 0; padding: 10px; background: #333; border-radius: 4px; max-height: 100px; overflow-y: auto;"></div>
    </div>
    <div id="code-editor"></div>
    <div class="code-review-buttons">
      <button id="code-review-cancel-button">Cancel</button>
      <button id="confirm-download-button">Confirm & Download</button>
    </div>
  </div>
</div>

<!-- Add help guide modal -->
<div class="help-overlay"></div>
<div class="help-guide">
  <button class="close-button" id="help-guide-close-button">&times;</button>
  <h2>Website Editor User Guide</h2>
  
  <div class="help-guide-section">
    <h3>Getting Started</h3>
    <ul>
      <li>Use the Login/Signup button to create an account and save your work to the cloud.</li>
      <li>Upload a local website by dragging an HTML file or ZIP archive into the upload area.</li>
      <li>Load a cloud project from the "My Projects" menu.</li>
    </ul>
  </div>

  <div class="help-guide-section">
    <h3>Saving Your Work</h3>
    <ul>
      <li>Click "Save Project" to save your current work to the cloud (requires login).</li>
      <li>Use the "Download Updated Code" button in the Code Explorer or Code Editor to get a local copy of your project as a ZIP file.</li>
    </ul>
  </div>
  
  <div class="help-guide-section">
    <h3>Basic Navigation</h3>
    <ul>
      <li>Use the "Switch to Code Explorer" button to toggle between the live preview and the code analysis view.</li>
      <li>The sidebar contains all your editing tools and can be toggled with the arrow button at the top-left.</li>
    </ul>
  </div>

  <div class="help-guide-section">
    <h3>Adding Components</h3>
    <ul>
      <li>First, enable "Edit Mode" using the button at the bottom of the screen.</li>
      <li>Drag and drop components from the "Component Library" in the sidebar directly onto your page.</li>
    </ul>
  </div>

  <div class="help-guide-section">
    <h3>Editing Elements</h3>
    <ul>
      <li>With "Edit Mode" active, click any element on the page to select it.</li>
      <li>Use the "Element Tools" in the sidebar to modify properties like dimensions, colors, text, and more.</li>
      <li>Use the corner handles to resize elements, and the top-right (x) handle to delete them.</li>
    </ul>
  </div>

  <div class="help-guide-section">
    <h3>AI Features</h3>
    <ul>
      <li>Use the chat bubble for general questions or assistance.</li>
      <li>Click "AI Edit Website" for making sitewide changes with a natural language prompt.</li>
    </ul>
  </div>
</div>


<!-- NEW: AUTH & PROJECT BROWSER MODALS -->
<div id="auth-modal" class="modal-overlay">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Login or Signup</h2>
    <div id="auth-form-container">
      <input type="text" id="auth-username" placeholder="Username">
      <input type="password" id="auth-password" placeholder="Password">
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="login-submit">Login</button>
        <button id="signup-submit">Signup</button>
      </div>
      <p id="auth-message" class="error-message"></p>
    </div>
  </div>
</div>

<div id="project-browser-modal" class="modal-overlay">
  <div class="modal-content">
     <span class="modal-close">&times;</span>
     <h2>My Projects</h2>
     <div id="project-list-container">
        <!-- Projects will be listed here -->
        <p>Loading projects...</p>
     </div>
     <button id="create-new-project-button">Start New Local Project</button>
     <p id="project-message"></p>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/ace.js"></script>
<script type="module">
// CORRECTED: Import from the correct file name
import * as api from './api (7).js';

// --- STATE MANAGEMENT ---
let currentUser = null;
let currentProjectId = null;
let currentProjectName = 'Untitled Project';

  const openDB = () => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('WebCodeExplorerDB', 1);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('projects')) db.createObjectStore('projects', { keyPath: 'id' });
        if (!db.objectStoreNames.contains('files')) {
          const store = db.createObjectStore('files', { keyPath: 'path' });
          store.createIndex('projectId', 'projectId', { unique: false });
        }
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  };

  // Global registries and history
  const functionHistory = [];
  let currentHistoryIndex = -1;
  const functionRegistry = {};
  let styleRegistry = {};
  let eventRegistry = {};
  let currentEditingFunction = null;
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const previewFrame = document.getElementById('preview-frame');
  let currentWebsiteCode = '';
  const chatBubble = document.querySelector('.chat-bubble');
  const chatWindow = document.querySelector('.chat-window');
  const chatClose = document.querySelector('.chat-close');
  const chatMessages = document.querySelector('.chat-messages');
  const chatInput = document.querySelector('.chat-input input');
  const chatSend = document.querySelector('.chat-input button');
  const chatOverlay = document.querySelector('.chat-overlay');
  
  let conversationHistory = [];
  let moveElementsEnabled = false;
  let selectedElement = null;
  let projectFiles = {};
  let isZipProject = false;
  let currentFilePath = '';
  let draggedComponent = null;
  let dropIndicator = document.querySelector('.drop-indicator');
  let editModeEnabled = false;
  let elementToDelete = null;

  const elementPositions = new WeakMap();

  const ProjectStorage = {
    async saveProject() {
        const projectData = {
            isZipProject,
            currentFilePath,
            currentWebsiteCode,
            projectFiles: isZipProject ? this.processFilesForStorage(projectFiles) : null,
            lastUpdated: new Date().toISOString()
        };
        try {
            localStorage.setItem('webCodeExplorerProject', JSON.stringify(projectData));
        } catch (e) {
            console.error('Error saving project to localStorage:', e);
        }
    },
    processFilesForStorage(files) {
        const result = {};
        for (const [path, file] of Object.entries(files)) {
            result[path] = (file.type === 'image' || file.type === 'binary') 
                ? { type: file.type, mimeType: file.mimeType || getMimeType(path), size: file.blob?.size || 0, isBinary: true }
                : file;
        }
        return result;
    },
    async loadProject() {
        const savedData = localStorage.getItem('webCodeExplorerProject');
        if (!savedData) return false;
        try {
            const projectData = JSON.parse(savedData);
            isZipProject = projectData.isZipProject;
            currentFilePath = projectData.currentFilePath;
            currentWebsiteCode = projectData.currentWebsiteCode;
            
            if (isZipProject && projectData.projectFiles) {
                projectFiles = {};
                for (const [path, fileData] of Object.entries(projectData.projectFiles)) {
                    projectFiles[path] = fileData.isBinary 
                        ? { type: fileData.type, mimeType: fileData.mimeType, needsReload: true }
                        : fileData;
                }
                renderFileTree();
                if (currentFilePath) await this.loadCurrentFileWithFallback();
            } else if (currentWebsiteCode) {
                await processHTMLContent(currentWebsiteCode);
            }
            return true;
        } catch (e) {
            console.error('Error loading project from localStorage:', e);
            return false;
        }
    },
    async loadCurrentFileWithFallback() {
        try {
            await loadProjectFile(currentFilePath);
        } catch (e) {
            const htmlFile = Object.keys(projectFiles).find(path => path.endsWith('.html') || path.endsWith('.htm'));
            if (htmlFile) {
                currentFilePath = htmlFile;
                await loadProjectFile(currentFilePath);
            }
        }
    }
  };
  
  // Component Library Toggle
  const componentTabs = document.querySelectorAll('.component-tab');
  const componentCategories = document.querySelectorAll('.component-category');

  // Edit mode controls
  const toggleEditModeButton = document.getElementById('toggleEditMode');
  const deleteElementButton = document.getElementById('deleteElementButton');

  // Initialize component library tabs
  componentTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      componentTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      componentCategories.forEach(cat => cat.style.display = 'none');
      document.querySelector(`.component-category[data-category="${tab.dataset.tab}"]`).style.display = 'block';
    });
  });

  // Initialize drag events for components
  const componentItems = document.querySelectorAll('.component-item');
  componentItems.forEach(item => {
    item.addEventListener('dragstart', handleComponentDragStart);
    item.addEventListener('dragend', handleComponentDragEnd);
    item.addEventListener('click', handleComponentTap);
  });

  function handleComponentDragStart(e) {
    draggedComponent = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', e.target.dataset.type);
    e.dataTransfer.effectAllowed = 'copy';
  }

  function handleComponentDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedComponent = null;
    dropIndicator.style.display = 'none';
  }

  function handleComponentTap(e) {
    if (window.innerWidth > 768) return;
    e.preventDefault();
    const componentData = e.currentTarget.dataset;
    const frame = document.getElementById('preview-frame');
    const frameDoc = frame.contentDocument || frame.contentWindow.document;
    const newElement = frameDoc.createElement('div');
    newElement.innerHTML = componentData.content;
    const elementToInsert = newElement.firstElementChild;
    makeElementDraggable(elementToInsert);
    makeElementResizable(elementToInsert);
    const viewportHeight = frameDoc.documentElement.clientHeight;
    const scrollTop = frameDoc.documentElement.scrollTop || frameDoc.body.scrollTop;
    elementToInsert.style.position = 'absolute';
    elementToInsert.style.left = '50%';
    elementToInsert.style.top = (viewportHeight / 2 + scrollTop) + 'px';
    elementToInsert.style.transform = 'translate(-50%, -50%)';
    elementToInsert.style.zIndex = '1000';
    frameDoc.body.appendChild(elementToInsert);
    Array.from(frameDoc.getElementsByTagName('*')).forEach(el => el.classList.remove('highlight'));
    elementToInsert.classList.add('highlight');
    updateWebsiteCode(frameDoc);
    showToast(`Added ${componentData.type} component`);
  }

  function showToast(message) {
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.className = 'toast-container';
      document.body.appendChild(toastContainer);
    }
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('fade-out');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  // Set up drop events for the preview frame
  const iframeOverlay = document.querySelector('.iframe-overlay');
  iframeOverlay.addEventListener('dragover', handleFrameDragOver);
  iframeOverlay.addEventListener('dragleave', handleFrameDragLeave);
  iframeOverlay.addEventListener('drop', handleFrameDrop);

  function handleFrameDragOver(e) {
    e.preventDefault();
    if (!draggedComponent) return;
    dropIndicator.style.width = '100px';
    dropIndicator.style.height = '50px';
    dropIndicator.style.left = `${e.clientX - 50}px`;
    dropIndicator.style.top = `${e.clientY - 25}px`;
    dropIndicator.style.display = 'block';
  }

  function handleFrameDragLeave(e) {
    dropIndicator.style.display = 'none';
  }

  function handleFrameDrop(e) {
    e.preventDefault();
    dropIndicator.style.display = 'none';
    if (!draggedComponent) return;
    const frame = document.getElementById('preview-frame');
    const frameDoc = frame.contentDocument || frame.contentWindow.document;
    const frameRect = frame.getBoundingClientRect();
    const x = e.clientX - frameRect.left;
    const y = e.clientY - frameRect.top;
    const newElement = frameDoc.createElement('div');
    newElement.innerHTML = draggedComponent.dataset.content;
    const elementToInsert = newElement.firstElementChild;
    makeElementDraggable(elementToInsert);
    makeElementResizable(elementToInsert);
    elementToInsert.style.position = 'absolute';
    elementToInsert.style.left = `${x}px`;
    elementToInsert.style.top = `${y}px`;
    elementToInsert.style.zIndex = '1000';
    frameDoc.body.appendChild(elementToInsert);
    Array.from(frameDoc.getElementsByTagName('*')).forEach(el => el.classList.remove('highlight'));
    elementToInsert.classList.add('highlight');
    updateWebsiteCode(frameDoc);
  }

  async function updateWebsite(prompt) {
    const button = document.getElementById('generateButton');
    button.classList.add('generating');
    button.disabled = true;
    try {
        let currentContent = isZipProject ? Object.entries(projectFiles).map(([path, file]) => `=== ${path} ===\n${file.type === 'text' ? file.content : '[Binary/Image file]'}`).join('\n\n') : currentWebsiteCode;
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiConfig.apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: `Update this website according to: ${prompt}\n\nCurrent content:\n${currentContent}` }] }] })
        });
        if (!response.ok) throw new Error(`API request failed: ${response.status}`);
        const data = await response.json();
        const responseText = data.candidates[0].content.parts[0].text;
        if (isZipProject) {
            const updates = JSON.parse(responseText);
            Object.entries(updates.files).forEach(([path, content]) => {
                if (projectFiles[path]) projectFiles[path].content = content;
                else projectFiles[path] = { type: 'text', content };
            });
            await saveProjectToStorage();
            if (currentFilePath) await loadProjectFile(currentFilePath);
        } else {
            currentWebsiteCode = responseText.match(/<!DOCTYPE html>[\s\S]*<\/html>/i)?.[0] || responseText;
            await saveProjectToStorage();
            await processHTMLContent(currentWebsiteCode);
        }
        showToast("Website updated successfully!");
    } catch (error) {
        console.error('Error updating website:', error);
        alert('Error updating website: ' + error.message);
    } finally {
        button.classList.remove('generating');
        button.disabled = false;
    }
  }

  function updateWebsiteCode(frameDoc) {
    const htmlContent = frameDoc.documentElement.outerHTML;
    if (isZipProject && projectFiles[currentFilePath]) {
      projectFiles[currentFilePath].content = htmlContent;
      projectFiles[currentFilePath].needsPathRestoration = true;
    } else if (!isZipProject) {
      currentWebsiteCode = htmlContent;
    }
  }

  toggleEditModeButton.addEventListener('click', () => {
    editModeEnabled = !editModeEnabled;
    const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
    const overlay = document.querySelector('.iframe-overlay');
    if (editModeEnabled) {
      toggleEditModeButton.classList.add('active');
      frameDoc.body.classList.add('edit-mode-active');
      overlay.style.display = 'block';
    } else {
      toggleEditModeButton.classList.remove('active');
      frameDoc.body.classList.remove('edit-mode-active');
      overlay.style.display = 'none';
    }
  });

  deleteElementButton.addEventListener('click', () => {
    if (!elementToDelete) return;
    elementToDelete.remove();
    updateWebsiteCode(elementToDelete.ownerDocument);
    elementToDelete = null;
    deleteElementButton.disabled = true;
  });

  document.getElementById('toggleMoveElements').addEventListener('change', function(e) {
    moveElementsEnabled = e.target.checked;
    const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
    const elements = frameDoc.querySelectorAll('.draggable');
    elements.forEach(element => element.style.cursor = moveElementsEnabled ? 'move' : '');
  });

  function addMessage(message, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.textContent = message;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    conversationHistory.push({ role: sender === "user" ? "user" : "model", parts: [{ text: message }] });
    if (conversationHistory.length > 10) conversationHistory.shift();
  }

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    chatInput.value = '';
    addMessage(message, 'user');
    try {
        let codeContext = isZipProject ? Object.entries(projectFiles).map(([p, f]) => `${p}:\n${f.type === 'text' ? f.content : '[Binary]'}`).join('\n') : currentWebsiteCode;
        const systemInstruction = { role: "user", parts: [{text: `System instruction: You are a web dev expert analyzing this code:\n${codeContext}\nRespond to the next user message.`}]};
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiConfig.apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [systemInstruction, ...conversationHistory] })
        });
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const data = await response.json();
        addMessage(data.candidates[0].content.parts[0].text, 'assistant');
    } catch (error) {
        console.error('Error sending message:', error);
        addMessage('Sorry, there was an error processing your request.', 'assistant');
    }
  }

  chatBubble.addEventListener('click', () => { chatWindow.style.display = 'flex'; chatOverlay.classList.add('open'); });
  chatClose.addEventListener('click', () => { chatWindow.style.display = 'none'; chatOverlay.classList.remove('open'); });
  chatOverlay.addEventListener('click', () => { chatWindow.style.display = 'none'; chatOverlay.classList.remove('open'); });
  chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
  chatSend.addEventListener('click', sendMessage);

  let currentView = "playground";
  function setView(view) {
    currentView = view;
    document.getElementById("playgroundContainer").style.display = view === "playground" ? 'flex' : 'none';
    document.getElementById("codeDisplayContainer").style.display = view === "code" ? 'block' : 'none';
    document.getElementById("toggleViewButton").textContent = `Switch to ${view === "playground" ? "Code Explorer" : "Playground"}`;
  }
  function toggleView() { setView(currentView === "playground" ? "code" : "playground"); }
  
  // File upload and processing
  dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
  dropzone.addEventListener('drop', async e => { e.preventDefault(); dropzone.classList.remove('dragover'); await handleFile(e.dataTransfer.files[0]); });
  fileInput.addEventListener('change', async e => await handleFile(e.target.files[0]));

async function saveProjectToStorage() {
  const db = await openDB();
  const tx = db.transaction(['projects', 'files'], 'readwrite');
  tx.objectStore('projects').put({ id: 'current', isZipProject, currentFilePath, currentWebsiteCode, lastUpdated: new Date().toISOString() });
  if (isZipProject) {
    for (const [path, file] of Object.entries(projectFiles)) {
      tx.objectStore('files').put({ path, projectId: 'current', ...file });
    }
  }
  return new Promise(resolve => tx.oncomplete = resolve);
}  

async function loadProjectFromStorage() {
  const db = await openDB();
  const projectData = await new Promise(resolve => db.transaction('projects').objectStore('projects').get('current').onsuccess = e => resolve(e.target.result));
  if (!projectData) return false;

  isZipProject = projectData.isZipProject;
  currentFilePath = projectData.currentFilePath;
  currentWebsiteCode = projectData.currentWebsiteCode;

  if (isZipProject) {
    projectFiles = {};
    const files = await new Promise(resolve => db.transaction('files').objectStore('files').index('projectId').getAll('current').onsuccess = e => resolve(e.target.result));
    for (const fileData of files) {
      projectFiles[fileData.path] = { type: fileData.type, content: fileData.content, blob: fileData.blob, url: fileData.blob ? URL.createObjectURL(fileData.blob) : fileData.url };
    }
    renderFileTree();
    if (currentFilePath) await loadProjectFile(currentFilePath);
  } else if (currentWebsiteCode) {
    await processHTMLContent(currentWebsiteCode);
  }
  return true;
}

  
  // Clear current project
  async function clearCurrentProject() {
      if (!currentWebsiteCode && Object.keys(projectFiles).length === 0 && !currentProjectId) return;
      if (!confirm('Are you sure you want to clear the current project? This will remove all local unsaved changes.')) return;
      currentWebsiteCode = ''; projectFiles = {}; isZipProject = false; currentFilePath = ''; currentProjectId = null; currentProjectName = 'Untitled Project';
      const frame = document.getElementById('preview-frame');
      if (frame) {
          frame.srcdoc = '<html><head><title>Cleared</title></head><body></body></html>';
      }
      document.getElementById('fileTree').innerHTML = '';
      document.getElementById('zipUploadMessage').textContent = '';
      localStorage.removeItem('webCodeExplorerProject');
      checkForProject();
      document.querySelector('.create-new-section').classList.add('show');
  }  
  
  // FIXED: Removed the first duplicate handleFile function. This is the correct one.
  async function handleFile(file) {
      await clearCurrentProject();
      if (!file) {
          checkForProject();
          return;
      }
      currentProjectName = file.name;

      if (file.type.includes('html')) {
          const content = await readFileAsText(file);
          currentWebsiteCode = content;
          isZipProject = false;
          await processHTMLContent(content);
      } else if (file.name.endsWith('.zip')) {
          isZipProject = true;
          document.getElementById('zipUploadMessage').textContent = 'Extracting ZIP archive...';
          try {
              await extractZipFile(file);
              document.getElementById('zipUploadMessage').textContent = 'ZIP extracted successfully!';
              document.getElementById('fileBrowser').style.display = 'block';
              const htmlFile = Object.keys(projectFiles).find(path => path.endsWith('.html') || path.endsWith('.htm'));
              if (htmlFile) {
                  renderFileTree();
                  currentFilePath = htmlFile;
                  await loadProjectFile(currentFilePath);
              } else {
                  document.getElementById('zipUploadMessage').textContent = 'No HTML files found in ZIP.';
              }
          } catch (error) {
              console.error('Error extracting ZIP:', error);
              document.getElementById('zipUploadMessage').textContent = 'Error: ' + error.message;
          }
      } else {
          alert('Please upload an HTML file or ZIP archive');
      }
      checkForProject();
  }

  async function extractZipFile(zipFile) {
    if (!window.zip) {
       const script = document.createElement('script');
       script.src = 'https://cdn.jsdelivr.net/npm/@zip.js/zip.js/dist/zip.min.js';
       document.head.appendChild(script);
       await new Promise(resolve => script.onload = resolve);
    }
    const reader = new zip.ZipReader(new zip.BlobReader(zipFile));
    const entries = await reader.getEntries();
    for (const entry of entries) {
      if (entry.directory) continue;
      const isImage = /\.(jpg|jpeg|png|gif|svg|webp|ico)$/i.test(entry.filename);
      if (isImage) {
        const blob = await entry.getData(new zip.BlobWriter(getMimeType(entry.filename)));
        projectFiles[entry.filename] = { type: 'image', url: URL.createObjectURL(blob), blob: blob };
      } else {
        try {
          const content = await entry.getData(new zip.TextWriter());
          projectFiles[entry.filename] = { type: 'text', content: content };
        } catch (e) {
          const blob = await entry.getData(new zip.BlobWriter(getMimeType(entry.filename)));
          projectFiles[entry.filename] = { type: 'binary', url: URL.createObjectURL(blob), blob: blob };
        }
      }
    }
    await reader.close();
  }
  
  function resolveRelativePath(baseDir, relativePath) {
    if (relativePath.startsWith('/')) return relativePath.substring(1);
    const parts = (baseDir + relativePath).split('/');
    const stack = [];
    for (const part of parts) {
        if (part === '..') stack.pop();
        else if (part !== '.') stack.push(part);
    }
    return stack.join('/');
  }

  function renderFileTree() {
    const fileTree = document.getElementById('fileTree');
    fileTree.innerHTML = '';
    const fileStructure = {};
    Object.keys(projectFiles).forEach(path => {
      let current = fileStructure;
      path.split('/').forEach((part, index, arr) => {
        if (index === arr.length - 1) current[part] = path;
        else current = current[part] = current[part] || {};
      });
    });
    fileTree.appendChild(renderFileStructure(fileStructure));
  }
  
  function renderFileStructure(structure) {
    const ul = document.createElement('ul');
    ul.className = 'file-list';
    Object.keys(structure).sort().forEach(key => {
      const value = structure[key];
      const li = document.createElement('li');
      if (typeof value === 'string') {
        li.className = 'file-item';
        li.innerHTML = `<span class="file-icon">${getFileIcon(key.split('.').pop())}</span><span>${key}</span>`;
        li.addEventListener('click', () => loadProjectFile(value));
        li.dataset.path = value;
        if (value === currentFilePath) li.classList.add('active');
      } else {
        li.innerHTML = `<strong>${key}/</strong>`;
        li.appendChild(renderFileStructure(value));
      }
      ul.appendChild(li);
    });
    return ul;
  }
  
  function getFileIcon(fileType) {
    const icons = {'html': 'üìÑ', 'css': 'üé®', 'js': 'üîß', 'json': 'üìã', 'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'svg': 'üñºÔ∏è', 'txt': 'üìù'};
    return icons[fileType.toLowerCase()] || 'üìÑ';
  }
  
  async function loadProjectFile(filePath) {
    if (!projectFiles[filePath]) return console.error('File not found:', filePath);
    currentFilePath = filePath;
    document.querySelectorAll('.file-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`.file-item[data-path="${filePath}"]`);
    if (activeItem) activeItem.classList.add('active');

    const fileData = projectFiles[filePath];
    if (fileData.type === 'image') return displayImageFile(filePath, fileData.url);
    if (fileData.type === 'binary') return displayBinaryFile(filePath, fileData.url);

    if (filePath.endsWith('.html') || filePath.endsWith('.htm')) {
        let htmlContent = fileData.content;
        const baseDir = filePath.substring(0, filePath.lastIndexOf('/') + 1);
        const parser = new DOMParser();
        const tempDoc = parser.parseFromString(htmlContent, 'text/html');
        const resourcePromises = [];
        
        const resolveAndUpdate = (el, attr, mime) => {
            const path = el.getAttribute(attr);
            if (path && !path.startsWith('http') && !path.startsWith('data:')) {
                const resourcePath = resolveRelativePath(baseDir, path);
                const resource = projectFiles[resourcePath];
                if (resource) {
                    const promise = (resource.type === 'image' || resource.type === 'binary') 
                        ? Promise.resolve(resource.url)
                        : Promise.resolve().then(() => {
                            const blob = new Blob([resource.content], { type: mime || getMimeType(resourcePath) });
                            resource.tempBlobUrl = URL.createObjectURL(blob);
                            return resource.tempBlobUrl;
                        });
                    resourcePromises.push(promise.then(url => {
                        el.setAttribute(attr, url);
                        el.setAttribute('data-original-path', path);
                    }));
                }
            }
        };
        tempDoc.querySelectorAll('img[src], video[src], audio[src], source[src], track[src], embed[src], iframe[src]').forEach(el => resolveAndUpdate(el, 'src'));
        tempDoc.querySelectorAll('link[rel="stylesheet"][href]').forEach(el => resolveAndUpdate(el, 'href', 'text/css'));
        tempDoc.querySelectorAll('link[rel*="icon"][href]').forEach(el => resolveAndUpdate(el, 'href'));
        tempDoc.querySelectorAll('script[src]').forEach(el => resolveAndUpdate(el, 'src', 'application/javascript'));

        await Promise.all(resourcePromises);
        processHTMLContent(tempDoc.documentElement.outerHTML);
    } else {
        displayTextFile(filePath, fileData.content);
    }
  }

  function displayImageFile(filePath, url){
    const frame = document.getElementById('preview-frame');
    frame.srcdoc = `<html><body style="background:#1e1e1e; margin:0; display:flex; align-items:center; justify-content:center;"><img src="${url}" style="max-width:100%; max-height:100%;"></body></html>`;
    document.getElementById('codeOutput').innerHTML = `Displaying image: ${filePath}`;
  }

  function displayTextFile(filePath, content) {
      const frame = document.getElementById('preview-frame');
      frame.srcdoc = `<html><head><title>${filePath}</title><style>body{background:#1e1e1e; color:#d4d4d4; font-family:monospace; white-space:pre;}</style></head><body>${escapeHtml(content)}</body></html>`;
      document.getElementById('codeOutput').innerHTML = `Displaying non-HTML file: ${filePath}`;
  }

  function displayBinaryFile(filePath, url) {
      const frame = document.getElementById('preview-frame');
      frame.srcdoc = `<html><body style="background:#1e1e1e; color:white; padding:20px;"><h2>Binary File</h2><p>Cannot display content for: ${filePath}</p><p><a href="${url}" download="${filePath.split('/').pop()}" style="color:#4fc3f7;">Download File</a></p></body></html>`;
      document.getElementById('codeOutput').innerHTML = `Displaying binary file: ${filePath}`;
  }
  
  function handleElementClick(e) {
    const element = e.target;
    Array.from(element.ownerDocument.getElementsByTagName('*')).forEach(el => el.classList.remove('highlight'));
    element.classList.add('highlight');
    if (element.classList.contains('draggable')) updateResizePanel(element);
    functionHistory.length = 0; currentHistoryIndex = -1;
    functionHistory.push({ type: 'element', element: element, content: generateElementContent(element) });
    currentHistoryIndex = 0;
    displayElementInfo(element);
    if (editModeEnabled) {
      elementToDelete = element;
      deleteElementButton.disabled = false;
    }
  }
  
  function generateElementContent(element) {
    let output = `<div class="edit-controls"><input type="text" class="edit-prompt" placeholder="Instructions..."><button data-action="edit-content-ai">Edit with AI</button><div class="loader"></div></div>`;
    output += `<div class="code-block"><h3>Element: ${element.tagName.toLowerCase()}</h3><pre class="code-content">${escapeHtml(element.outerHTML||'')}</pre></div>`;
    output += `<div class="css-rules"><h4>CSS Rules:</h4><pre>${escapeHtml(getApplicableStyles(element))}</pre></div>`;
    output += `<div class="event-handlers"><h4>Event Handlers:</h4><pre>${escapeHtml(JSON.stringify(getEventHandlers(element),null,2))}</pre></div>`;
    const relatedFunctions = getRelatedFunctions(element);
    if (relatedFunctions.length > 0) output += `<div class="dependency-tree"><h4>Related Functions:</h4>${relatedFunctions.map(f => displayFunctionAndDependencies(f)).join('')}</div>`;
    const jsReferences = findJavaScriptReferences(element);
    if (jsReferences.length > 0) output += `<div class="js-references"><h4>JavaScript References:</h4>${jsReferences.map(c => `<pre class="code-content">${c}</pre>`).join('')}</div>`;
    document.getElementById('codeOutput').innerHTML = output;
  }
  
  function displayElementInfo(element) { generateElementContent(element); }

  function getApplicableStyles(element) {
    let styles = '';
    for (const rule in styleRegistry) {
      if (rule.trim().startsWith('@')) continue;
      try { if (element.matches(rule)) styles += `${rule} { ${styleRegistry[rule]} }\n`; }
      catch (e) { console.warn(`Invalid selector '${rule}'`); }
    }
    return styles || 'No specific CSS rules found';
  }
  
  function getEventHandlers(element) {
    return eventRegistry[element.tagName.toLowerCase()] || {};
  }
  
  function getRelatedFunctions(element) {
    const functions = new Set();
    Array.from(element.attributes).forEach(attr => {
        if (attr.name.startsWith('on')) {
            const funcName = attr.value.match(/(\w+)\(.*\)/)?.[1];
            if (funcName && functionRegistry[funcName]) functions.add(funcName);
        }
    });
    return Array.from(functions);
  }
  
  function displayFunctionAndDependencies(functionName, level = 0) {
    const func = functionRegistry[functionName];
    if (!func) return '';
    let output = `<div class="code-block"><span class="function-name">${escapeHtml(functionName)}</span><div class="edit-buttons"><button data-action="edit-manual" data-func="${functionName}">Edit</button><button data-action="save-manual" data-func="${functionName}">Save</button><button data-action="edit-ai" data-func="${functionName}">AI Edit</button></div><pre class="code-content">${addFunctionLinks(escapeHtml(func.code||''))}</pre><div class="code-editor"><textarea>${escapeHtml(func.code||'')}</textarea></div>`;
    if (func.dependencies?.length > 0) {
      output += `<div class="dependency-tree"><h4>Dependencies:</h4>${func.dependencies.map(dep => displayFunctionAndDependencies(dep, level+1)).join('')}</div>`;
    }
    output += `</div>`;
    return output;
  }
  
  function addFunctionLinks(code) {
    return Object.keys(functionRegistry).sort((a,b)=>b.length-a.length).reduce((acc, funcName) => {
        const regex = new RegExp(`\\b(${funcName})\\b(?=\\s*\\()`, 'g');
        return acc.replace(regex, `<span class="function-link" data-action="show-func" data-func="${funcName}">$1</span>`);
    }, code);
  }
  
  function showFunction(functionName) {
    if (currentHistoryIndex < functionHistory.length - 1) functionHistory.splice(currentHistoryIndex + 1);
    functionHistory.push({ type: 'function', name: functionName, content: displayFunctionAndDependencies(functionName) });
    currentHistoryIndex++;
    document.getElementById('codeOutput').innerHTML = `<div class="navigation-controls"><button data-action="nav-back" ${currentHistoryIndex > 0 ? '' : 'disabled'} class="nav-button">‚Üê Back</button></div><div class="code-block">${functionHistory[currentHistoryIndex].content}</div>`;
  }
  
  function navigateHistory(direction) {
    if (direction === 'back' && currentHistoryIndex > 0) {
      currentHistoryIndex--;
      const previous = functionHistory[currentHistoryIndex];
      document.getElementById('codeOutput').innerHTML = `<div class="navigation-controls"><button data-action="nav-back" ${currentHistoryIndex > 0 ? '' : 'disabled'} class="nav-button">‚Üê Back</button></div><div class="code-block">${previous.content}</div>`;
      if (previous.type === 'element' && previous.element?.ownerDocument) {
        Array.from(previous.element.ownerDocument.getElementsByTagName('*')).forEach(el => el.classList.remove('highlight'));
        previous.element.classList.add('highlight');
      }
    }
  }
  
  function findJavaScriptReferences(element) { /* implementation omitted for brevity */ return []; }
  
  function extractFunctions(code) {
    const funcRegex = /(?:function\s+(\w+)\s*\(|^(?:const|let|var)\s+(\w+)\s*=\s*(?:async)?\s*(?:\([^)]*\)|[\w]+)\s*=>)/gm;
    let match;
    while ((match = funcRegex.exec(code)) !== null) {
        const name = match[1] || match[2];
        const bodyStart = code.indexOf('{', match.index);
        if (bodyStart === -1) continue;
        const body = extractCompleteCodeBlock(code, bodyStart);
        if (body) {
            functionRegistry[name] = { code: body, dependencies: findFunctionDependencies(body) };
        }
    }
  }

  function extractCompleteCodeBlock(code, openBraceIndex) {
    let braceCount = 1, i = openBraceIndex + 1;
    while (braceCount > 0 && i < code.length) {
      if (code[i] === '{') braceCount++;
      if (code[i] === '}') braceCount--;
      i++;
    }
    return braceCount === 0 ? code.substring(openBraceIndex, i) : null;
  }

  function findFunctionDependencies(functionBody) {
    const deps = new Set();
    Object.keys(functionRegistry).forEach(func => {
        if (new RegExp(`\\b${func}\\b\\s*\\(`, 'g').test(functionBody)) deps.add(func);
    });
    return Array.from(deps);
  }

  function extractStyles(styleContent) {
    const ruleRegex = /([^{]+)\{([^}]+)\}/g;
    let match;
    while ((match = ruleRegex.exec(styleContent)) !== null) {
        styleRegistry[match[1].trim()] = match[2].trim();
    }
  }

  function extractEventHandlers(element) {
    Array.from(element.querySelectorAll('*')).forEach(el => {
        const handlers = {};
        Array.from(el.attributes).forEach(attr => { if (attr.name.startsWith('on')) handlers[attr.name.substring(2)] = attr.value; });
        if (Object.keys(handlers).length > 0) eventRegistry[el.tagName.toLowerCase()] = handlers;
    });
  }

  function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

  async function processGlobalAIEdit() {
    const instructions = document.getElementById('global-ai-instructions').value.trim();
    if (!instructions) return alert('Please describe your changes.');
    const editButton = document.getElementById('global-ai-edit');
    editButton.classList.add('processing');
    try {
        let currentContent = isZipProject ? JSON.stringify(Object.fromEntries(Object.entries(projectFiles).map(([p, f]) => [p, f.type === 'text' ? f.content : '[Binary]']))) : currentWebsiteCode;
        const prompt = `Change this website based on these instructions: ${instructions}. Current content: ${currentContent}. Respond STRICTLY with a JSON object { "changes": { "path/to/file.ext": "new content" } } only including changed files.`;
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiConfig.apiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const data = await response.json();
        const jsonText = data.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/)[0];
        const parsedResponse = JSON.parse(jsonText);
        
        if (!parsedResponse?.changes) throw new Error("Invalid response format.");
        
        Object.entries(parsedResponse.changes).forEach(([path, newContent]) => {
            if (isZipProject) {
                if (projectFiles[path]) projectFiles[path].content = newContent;
                else projectFiles[path] = { type: 'text', content: newContent };
            } else {
                currentWebsiteCode = newContent;
            }
        });
        await saveProjectToStorage();
        if (isZipProject && currentFilePath) await loadProjectFile(currentFilePath);
        else await processHTMLContent(currentWebsiteCode);
        showToast('Changes applied successfully!');
    } catch (error) {
        console.error('Error processing AI edit:', error);
        alert('Error processing changes: ' + error.message);
    } finally {
        editButton.classList.remove('processing');
    }
  }
  
  function getMimeType(filename) {
    const mimes = {'html': 'text/html', 'css': 'text/css', 'js': 'application/javascript', 'json': 'application/json', 'png': 'image/png', 'jpg': 'image/jpeg', 'svg': 'image/svg+xml'};
    return mimes[filename.split('.').pop().toLowerCase()] || 'application/octet-stream';
  }

  function closeGlobalAIModal() {
    document.getElementById('global-ai-modal').style.display = 'none';
    document.getElementById('global-ai-instructions').value = '';
  }

  // --- APP INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', initApp);
  
</script>
</body>
  </html>
